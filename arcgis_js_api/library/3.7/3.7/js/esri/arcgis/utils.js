/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
require({cache:{"esri/layers/FeatureEditResult":function(){define(["dojo/_base/declare","dojo/_base/lang","dojo/has","esri/kernel"],function(l,f,q,h){l=l(null,{declaredClass:"esri.layers.FeatureEditResult",constructor:function(h){h&&f.isObject(h)&&(this.objectId=h.objectId,this.success=h.success,h.success||(h=h.error,this.error=Error(),this.error.code=h.code,this.error.message=h.description))}});q("extend-esri")&&f.setObject("layers.FeatureEditResult",l,h);return l})},"esri/layers/MapImageLayer":function(){define("dojo/_base/declare dojo/_base/connect dojo/_base/lang dojo/_base/array dojo/dom-construct dojo/dom-style esri/kernel esri/config esri/sniff esri/domUtils esri/geometry/Point esri/geometry/webMercatorUtils esri/layers/layer".split(" "),
function(l,f,q,h,s,n,d,p,c,k,m,b,r){var a=l([r],{declaredClass:"esri.layers.MapImageLayer","-chains-":{constructor:"manual"},constructor:function(g){this.inherited(arguments,[null,g]);this._mapImages=[];var e=q.hitch;this._panStart=e(this,this._panStart);this._pan=e(this,this._pan);this._extentChange=e(this,this._extentChange);this._zoom=e(this,this._zoom);this._zoomStart=e(this,this._zoomStart);this._scale=e(this,this._scale);this._resize=e(this,this._resize);f.connect(this,"onSuspend",this,this._onSuspend);
f.connect(this,"onResume",this,this._onResume);this.loaded=!0;this.onLoad(this)},opacity:1,_transform:d._getDOMAccessor("transform"),addImage:function(g){var e=this._mapImages.push(g),e=e-1;g._idx=e;g._layer=this;this._div&&this._createImage(g,e)},removeImage:function(g){if(g){var e=g._idx,a=this._mapImages;if(a[e]===g){delete a[e];if(e=g._node)this._clearEvents(e),e.e_idx=e.e_bl=e.e_tr=e.e_l=e.e_t=e.e_w=e.e_h=null,e.parentNode&&(e.parentNode.removeChild(e),s.destroy(e));g._node=g._idx=g._layer=null}}},
removeAllImages:function(){var g=this._mapImages,e,a=g.length;for(e=0;e<a;e++){var b=g[e];b&&this.removeImage(b)}this._mapImages=[]},getImages:function(){var g=this._mapImages,e=[],a,b=g.length;for(a=0;a<b;a++)g[a]&&e.push(g[a]);return e},setOpacity:function(g){this.opacity!=g&&(this._opacityChanged(this.opacity=g),this.onOpacityChange())},onOpacityChange:function(){},_opacityChanged:function(g){var e=this._div,a,b;if(e)if(!c("ie")||8<c("ie"))n.set(e,"opacity",g);else{b=e.childNodes;a=b.length;for(e=
0;e<a;e++)n.set(b[e],"opacity",g)}},_createImage:function(g,e){var b=s.create("img");n.set(b,{position:"absolute"});8>=c("ie")&&n.set(b,"opacity",this.opacity);if(g.rotation){var d="rotate("+(360-g.rotation)+"deg)";9>c("ie")||(n.set(b,this._transform,d),n.set(b,"transform",d))}g._node=b;b.e_idx=e;b.e_layer=this;b.e_load=f.connect(b,"onload",a.prototype._imageLoaded);b.e_error=f.connect(b,"onerror",a.prototype._imageError);b.e_abort=f.connect(b,"onabort",a.prototype._imageError);b.src=g.href},_imageLoaded:function(g,
e){var a=e||g.target||g.currentTarget,b=a.e_layer,c=b._mapImages[a.e_idx],d=b._map;d&&(d.__zooming||d.__panning||!b._sr)?b._standby.push(a):(b._clearEvents(a),c&&c._node===a&&d&&b._attach(c))},_imageError:function(g){g=g.target||g.currentTarget;var e=g.e_layer,a=e._mapImages[g.e_idx];e._clearEvents(g);a&&(a._node=null)},_clearEvents:function(g){var e=f.disconnect;e(g.e_load);e(g.e_error);e(g.e_abort);g.e_load=g.e_error=g.e_abort=g.e_layer=null},_attach:function(g){var e=g.extent,a=e.spatialReference,
c=this._sr,d=this._div,f=g._node,r=new m({x:e.xmin,y:e.ymin,spatialReference:a}),e=new m({x:e.xmax,y:e.ymax,spatialReference:a});c.equals(a)||(c.isWebMercator()&&4326===a.wkid?(r=b.geographicToWebMercator(r),e=b.geographicToWebMercator(e)):a.isWebMercator()&&4326===c.wkid&&(r=b.webMercatorToGeographic(r),e=b.webMercatorToGeographic(e)));f.e_bl=r;f.e_tr=e;g.visible&&(this._setPos(f,d._left,d._top),(this._active||d).appendChild(f))},_setPos:function(g,e,a){var b=g.e_bl,c=g.e_tr,m=this._map,b=m.toScreen(b),
c=m.toScreen(c);e=b.x-e;a=c.y-a;var f=Math.abs(c.x-b.x),b=Math.abs(b.y-c.y),c={width:f+"px",height:b+"px"},r=this._mapImages[g.e_idx];"css-transforms"===m.navigationMode?c[d._css.names.transform]=d._css.translate(e,a)+(r.rotation?" "+d._css.rotate(360-r.rotation):""):(c.left=e+"px",c.top=a+"px");n.set(g,c);g.e_l=e;g.e_t=a;g.e_w=f;g.e_h=b},managedSuspension:!0,_setMap:function(g,e){this.inherited(arguments);var a=this._div=s.create("div",null,e),b=d._css.names,m={position:"absolute"},f=g.__visibleDelta;
if(!c("ie")||8<c("ie"))m.opacity=this.opacity;"css-transforms"===g.navigationMode?(m[b.transform]=d._css.translate(f.x,f.y),n.set(a,m),a._left=f.x,a._top=f.y,m={position:"absolute",width:g.width+"px",height:g.height+"px",overflow:"visible"},this._active=s.create("div",null,a),n.set(this._active,m),this._passive=s.create("div",null,a),n.set(this._passive,m)):(a._left=0,a._top=0,n.set(a,m));this._standby=[];b=this._mapImages;f=b.length;for(m=0;m<f;m++){var r=b[m];r._node||this._createImage(r,r._idx)}k.hide(a);
return a},_unsetMap:function(g,e){this._disconnect();var a=this._div;if(a){var b=this._mapImages,c,d=b.length;for(c=0;c<d;c++){var m=b[c];if(m){var f=m._node;f&&(this._clearEvents(f),f.e_idx=f.e_bl=f.e_tr=f.e_l=f.e_t=f.e_w=f.e_h=null);m._node=null}}e.removeChild(a);s.destroy(a)}this._map=this._div=this._sr=this._active=this._passive=this._standby=null;this.inherited(arguments)},_onSuspend:function(){this._disconnect();k.hide(this._div)},_onResume:function(g){g.firstOccurrence&&(this._sr=this._map.spatialReference,
this._processStandbyList());g=this._map;var e=this._div,a=g.__visibleDelta;"css-transforms"===g.navigationMode&&(e._left=a.x,e._top=a.y,n.set(e,d._css.names.transform,d._css.translate(e._left,e._top)));this._redraw("css-transforms"===g.navigationMode);this._connect(g);k.show(e)},_connect:function(g){if(!this._connections){var e=f.connect,a="css-transforms"===g.navigationMode;this._connections=[e(g,"onPanStart",this._panStart),e(g,"onPan",this._pan),e(g,"onExtentChange",this._extentChange),a&&e(g,
"onZoomStart",this._zoomStart),a?e(g,"onScale",this._scale):e(g,"onZoom",this._zoom),a&&e(g,"onResize",this._resize)]}},_disconnect:function(){this._connections&&(h.forEach(this._connections,f.disconnect),this._connections=null)},_panStart:function(){this._panL=this._div._left;this._panT=this._div._top},_pan:function(g,e){var a=this._div;a._left=this._panL+e.x;a._top=this._panT+e.y;"css-transforms"===this._map.navigationMode?n.set(a,d._css.names.transform,d._css.translate(a._left,a._top)):n.set(a,
{left:a._left+"px",top:a._top+"px"})},_extentChange:function(g,e,a){a?this._redraw("css-transforms"===this._map.navigationMode):e&&this._pan(g,e);this._processStandbyList()},_processStandbyList:function(){var a,e=this._standby;if(e&&e.length)for(a=e.length-1;0<=a;a--)this._imageLoaded(null,e[a]),e.splice(a,1)},_redraw:function(a){if(a){a=this._passive;var e=d._css.names;n.set(a,e.transition,"none");this._moveImages(a,this._active);n.set(a,e.transform,"none")}a=this._active||this._div;var e=this._div._left,
b=this._div._top,c,m=a.childNodes.length,f;for(c=0;c<m;c++)f=a.childNodes[c],this._setPos(f,e,b)},_zoom:function(a,e,b){a=this._div;var c=a._left,m=a._top,d,f=a.childNodes.length,r;for(d=0;d<f;d++){r=a.childNodes[d];var k=r.e_w*e,u=r.e_h*e,p=(b.x-c-r.e_l)*(k-r.e_w)/r.e_w,h=(b.y-m-r.e_t)*(u-r.e_h)/r.e_h,p=isNaN(p)?0:p,h=isNaN(h)?0:h;n.set(r,{left:r.e_l-p+"px",top:r.e_t-h+"px",width:k+"px",height:u+"px"})}},_zoomStart:function(){this._moveImages(this._active,this._passive)},_moveImages:function(a,e){var b=
a.childNodes,c;c=b.length;if(0<c)for(c-=1;0<=c;c--)e.appendChild(b[c])},_scale:function(a,e){var b=d._css.names,c=this._passive;n.set(c,b.transition,e?"none":b.transformName+" "+p.defaults.map.zoomDuration+"ms ease");d._css.matrix(a);n.set(c,b.transform,d._css.matrix(a))},_resize:function(a,e,b){n.set(this._active,{width:e+"px",height:b+"px"});n.set(this._passive,{width:e+"px",height:b+"px"})}});c("extend-esri")&&q.setObject("layers.MapImageLayer",a,d);return a})},"esri/layers/WebTiledLayer":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/_base/url dojo/has dojo/string esri/kernel esri/urlUtils esri/SpatialReference esri/geometry/Extent esri/layers/TiledMapServiceLayer esri/layers/TileInfo".split(" "),
function(l,f,q,h,s,n,d,p,c,k,m,b){l=l(m,{declaredClass:"esri.layers.WebTiledLayer",constructor:function(d,a){a||(a={});this.urlTemplate=d;var g=new k(-2.0037508342787E7,-2.003750834278E7,2.003750834278E7,2.0037508342787E7,new c({wkid:102100})),e=new k(-2.0037508342787E7,-2.003750834278E7,2.003750834278E7,2.0037508342787E7,new c({wkid:102100}));this.initialExtent=a.initialExtent||g;this.fullExtent=a.fullExtent||e;this.tileInfo=a.tileInfo?a.tileInfo:new b({rows:256,cols:256,origin:{x:-2.0037508342787E7,
y:2.0037508342787E7},spatialReference:{wkid:102100},lods:[{level:0,resolution:156543.033928,scale:5.91657527591555E8},{level:1,resolution:78271.5169639999,scale:2.95828763795777E8},{level:2,resolution:39135.7584820001,scale:1.47914381897889E8},{level:3,resolution:19567.8792409999,scale:7.3957190948944E7},{level:4,resolution:9783.93962049996,scale:3.6978595474472E7},{level:5,resolution:4891.96981024998,scale:1.8489297737236E7},{level:6,resolution:2445.98490512499,scale:9244648.868618},{level:7,resolution:1222.99245256249,
scale:4622324.434309},{level:8,resolution:611.49622628138,scale:2311162.217155},{level:9,resolution:305.748113140558,scale:1155581.108577},{level:10,resolution:152.874056570411,scale:577790.554289},{level:11,resolution:76.4370282850732,scale:288895.277144},{level:12,resolution:38.2185141425366,scale:144447.638572},{level:13,resolution:19.1092570712683,scale:72223.819286},{level:14,resolution:9.55462853563415,scale:36111.909643},{level:15,resolution:4.77731426794937,scale:18055.954822},{level:16,resolution:2.38865713397468,
scale:9027.977411},{level:17,resolution:1.19432856685505,scale:4513.988705},{level:18,resolution:0.597164283559817,scale:2256.994353},{level:19,resolution:0.298582141647617,scale:1128.497176}]});this.spatialReference=new c(this.tileInfo.spatialReference.toJson());this.copyright=a.copyright||"";var m=new h(d),g=m.scheme+"://"+m.authority+"/";this.urlPath=d.substring(g.length);this.tileServers=a.tileServers||[];-1===m.authority.indexOf("{subDomain}")&&this.tileServers.push(g);if(a.subDomains&&0<a.subDomains.length&&
1<m.authority.split(".").length){this.subDomains=a.subDomains;var f;q.forEach(a.subDomains,function(a,e){-1<m.authority.indexOf("${subDomain}")?f=m.scheme+"://"+n.substitute(m.authority,{subDomain:a})+"/":-1<m.authority.indexOf("{subDomain}")&&(f=m.scheme+"://"+m.authority.replace(/\{subDomain\}/gi,a)+"/");this.tileServers.push(f)},this)}this.tileServers=q.map(this.tileServers,function(a){"/"!==a.charAt(a.length-1)&&(a+="/");return a});this._levelToLevelValue=[];q.forEach(this.tileInfo.lods,function(a){this._levelToLevelValue[a.level]=
a.levelValue||a.level},this);this.loaded=!0;this.onLoad(this)},getTileUrl:function(b,a,g){b=this._levelToLevelValue[b];var e=this.tileServers[a%this.tileServers.length]+n.substitute(this.urlPath,{level:b,col:g,row:a}),e=e.replace(/\{level\}/gi,b).replace(/\{row\}/gi,a).replace(/\{col\}/gi,g),e=this.addTimestampToURL(e);return p.addProxy(e)}});s("extend-esri")&&f.setObject("layers.WebTiledLayer",l,d);return l})},"esri/layers/ServiceGeneratedFeatureCollection":function(){define("dojo/_base/declare dojo/_base/connect dojo/_base/lang dojo/_base/array dojo/dom-construct dojo/dom-style dojo/has esri/kernel esri/SpatialReference esri/geometry/Extent esri/geometry/webMercatorUtils esri/renderers/SimpleRenderer esri/layers/layer esri/layers/FeatureLayer esri/dijit/PopupTemplate".split(" "),
function(l,f,q,h,s,n,d,p,c,k,m,b,r,a,g){l=l([r],{declaredClass:"esri.layers._ServiceGeneratedFeatureCollection",constructor:function(a,b){this.pointSymbol=b&&b.pointSymbol;this.polylineSymbol=b&&b.polylineSymbol;this.polygonSymbol=b&&b.polygonSymbol;this._outSR=b&&(b.outSpatialReference||b.outSR)||new c({wkid:4326});this._options=b},parse:function(){console.error("parse function has not been implemented")},getFeatureLayers:function(){var a=[];this._fLayers&&(a=a.concat(this._fLayers));return a},onRefresh:function(){},
refresh:function(){this.loaded&&(this._map&&!this._io&&this.visible)&&this._createLayer()},_createLayer:function(a){var b=this;this._fireUpdateStart();a=this.parse(a);a.addCallback(function(a){b._io=null;b._initLayer(a)});a.addErrback(function(a){b._io=null;a=q.mixin(Error(),a);a.message="Unable to load resource: "+b.url+" "+(a.message||"");b._fireUpdateEnd(a);b.onError(a)})},_initLayer:function(e){this.loaded&&this._removeInternalLayers();this.name=e.name;this.description=e.description;this.snippet=
e.snippet;this.defaultVisibility=void 0!==e.visibility?this.visible=!!e.visibility:this.visible=!0;this.featureInfos=e.featureInfos;this.fullExtent=this.initialExtent=new k(e.lookAtExtent);this.copyright=e.author||e.copyright;var c;if((e=q.getObject("featureCollection.layers",!1,e))&&0<e.length)this._fLayers=[],h.forEach(e,function(e,b){var m=q.getObject("featureSet.features",!1,e);m&&0<m.length&&(c=q.mixin({outFields:["*"],infoTemplate:e.popupInfo?new g(e.popupInfo):null,editable:!1},this._options),
c.id&&(c.id=c.id+"_"+b),e.layerDefinition.capabilities="Query,Data",m=new a(e,c),m.geometryType&&(this["_"+m.geometryType]=m),this._fLayers.push(m))},this),0===this._fLayers.length&&delete this._fLayers;this.items=[];this._esriGeometryPoint&&(this.items=this.items.concat(this._esriGeometryPoint.graphics),this.pointSymbol&&(e=new b(this.pointSymbol),this._esriGeometryPoint.setRenderer(e)));this._esriGeometryPolyline&&(this.items=this.items.concat(this._esriGeometryPolyline.graphics),this.polylineSymbol&&
(e=new b(this.polylineSymbol),this._esriGeometryPolyline.setRenderer(e)));this._esriGeometryPolygon&&(this.items=this.items.concat(this._esriGeometryPolygon.graphics),this.polygonSymbol&&(e=new b(this.polygonSymbol),this._esriGeometryPolygon.setRenderer(e)));this._fireUpdateEnd();this.loaded&&(this._addInternalLayers(),this.onRefresh())},_addInternalLayers:function(){var a=this._map;this._fireUpdateStart();var b=a.spatialReference,g=this._outSR,c;if(b.wkid)c=b._isWebMercator()&&g._isWebMercator()||
b.wkid===g.wkid;else if(b.wkt)c=b.wkt===g.wkt;else{console.log("_setMap - map has invalid spatial reference");return}if(!c)if(b._isWebMercator()&&4326===g.wkid)this._converter=m.geographicToWebMercator;else if(g._isWebMercator()&&4326===b.wkid)this._converter=m.webMercatorToGeographic;else{console.log("_setMap - unsupported workflow. Spatial reference of the map and layer do not match, and the conversion cannot be done on the client.");return}(b=this._fLayers)&&0<b.length&&h.forEach(b,function(b){if(this._converter){var g=
b.graphics,c,m,d=g?g.length:0;for(c=0;c<d;c++)(m=g[c].geometry)&&g[c].setGeometry(this._converter(m))}a.addLayer(b)},this);this.setVisibility(this.visible);this._fireUpdateEnd()},_removeInternalLayers:function(){var a=this._map;a&&h.forEach(this.getFeatureLayers(),a.removeLayer,a)},onVisibilityChange:function(a){this._fireUpdateStart();h.forEach(this.getFeatureLayers(),function(b){b.setVisibility(a)});this._fireUpdateEnd()},_setMap:function(a,b){this.inherited(arguments);this._map=a;var g=this._div=
s.create("div",null,b);n.set(g,"position","absolute");this._addInternalLayers();this.evaluateSuspension();return g},_unsetMap:function(a,b){this._io&&this._io.cancel();f.disconnect(this._extChgHandle);delete this._extChgHandle;this._removeInternalLayers();var g=this._div;g&&(b.removeChild(g),s.destroy(g));this._div=null;this.inherited(arguments)}});d("extend-esri")&&q.setObject("layers._ServiceGeneratedFeatureCollection",l,p);return l})},"esri/layers/KMLGroundOverlay":function(){define("dojo/_base/declare dojo/_base/lang dojo/has esri/kernel esri/lang esri/layers/MapImage".split(" "),
function(l,f,q,h,s,n){l=l([n],{declaredClass:"esri.layers.KMLGroundOverlay",constructor:function(d){s.isDefined(this.visibility)&&(this.visible=!!this.visibility)}});q("extend-esri")&&f.setObject("layers.KMLGroundOverlay",l,h);return l})},"dojo/data/util/simpleFetch":function(){define(["../../_base/lang","../../_base/kernel","./sorter"],function(l,f,q){var h={};l.setObject("dojo.data.util.simpleFetch",h);h.errorHandler=function(h,n){n.onError&&n.onError.call(n.scope||f.global,h,n)};h.fetchHandler=
function(h,n){var d=n.abort||null,p=!1,c=n.start?n.start:0,k=n.count&&Infinity!==n.count?c+n.count:h.length;n.abort=function(){p=!0;d&&d.call(n)};var m=n.scope||f.global;n.store||(n.store=this);n.onBegin&&n.onBegin.call(m,h.length,n);n.sort&&h.sort(q.createSortFunction(n.sort,this));if(n.onItem)for(var b=c;b<h.length&&b<k;++b){var r=h[b];p||n.onItem.call(m,r,n)}n.onComplete&&!p&&(b=null,n.onItem||(b=h.slice(c,k)),n.onComplete.call(m,b,n))};h.fetch=function(f){f=f||{};f.store||(f.store=this);this._fetchItems(f,
l.hitch(this,"fetchHandler"),l.hitch(this,"errorHandler"));return f};return h})},"esri/layers/KMLLayer":function(){define("dojo/_base/kernel dojo/_base/declare dojo/_base/connect dojo/_base/lang dojo/_base/array dojo/_base/json dojo/_base/sniff dojo/io-query dojo/dom-construct dojo/dom-style esri/kernel esri/config esri/lang esri/request esri/SpatialReference esri/geometry/webMercatorUtils esri/dijit/PopupTemplate esri/layers/layer esri/layers/KMLFolder esri/layers/KMLGroundOverlay esri/layers/MapImageLayer esri/layers/FeatureLayer".split(" "),
function(l,f,q,h,s,n,d,p,c,k,m,b,r,a,g,e,x,y,v,z,F,A){var w=f([y],{declaredClass:"esri.layers.KMLLayer",serviceUrl:location.protocol+"//utility.arcgis.com/sharing/kml",constructor:function(a,e){a||console.log("KMLLayer:constructor - please provide url for the KML file");this._outSR=e&&e.outSR||new g({wkid:4326});this._options=e;b.defaults.kmlService&&(this.serviceUrl=b.defaults.kmlService);var c=this.linkInfo=e&&e.linkInfo;c&&(this.visible=!!c.visibility,this._waitingForMap=!!c.viewFormat);(!c||c&&
c.visibility&&!this._waitingForMap)&&this._parseKml();this.refresh=h.hitch(this,this.refresh);this.registerConnectEvents("esri.layers.KMLLayer",!0)},getFeature:function(a){if(a){var b=a.type,e=a.id,g;switch(b){case "esriGeometryPoint":case "esriGeometryPolyline":case "esriGeometryPolygon":(a=this["_"+b])&&(g=h.getObject("_mode._featureMap."+e,!1,a));break;case "GroundOverlay":if(a=this._groundLyr){var c=a.getImages(),b=c.length;for(a=0;a<b;a++)if(c[a].id===e){g=c[a];break}}break;case "ScreenOverlay":break;
case "NetworkLink":s.some(this._links,function(a){return a.linkInfo&&a.linkInfo.id===e?(g=a,!0):!1});break;case "Folder":b=(c=this.folders)?c.length:0;for(a=0;a<b;a++)if(c[a].id===e){g=c[a];break}break;default:console.log("KMLLayer:getFeature - unknown feature type")}return g}},getLayers:function(){var a=[];this._groundLyr&&a.push(this._groundLyr);this._fLayers&&(a=a.concat(this._fLayers));this._links&&s.forEach(this._links,function(b){b.declaredClass&&a.push(b)});return a},setFolderVisibility:function(a,
b){a&&(this._fireUpdateStart(),(a.visible=b)&&(b=this._areLocalAncestorsVisible(a)),this._setState(a,b),this._fireUpdateEnd())},onRefresh:function(){},_parseKml:function(b){var e=this;this._fireUpdateStart();this._io=a({url:this.serviceUrl,content:{url:this._url.path+this._getQueryParameters(b),model:"simple",folders:"",refresh:this.loaded?!0:void 0,outSR:n.toJson(this._outSR.toJson())},callbackParamName:"callback",load:function(a){e._io=null;e._initLayer(a)},error:function(a){e._io=null;a=h.mixin(Error(),
a);a.message="Unable to load KML: "+e.url+" "+(a.message||"");e._fireUpdateEnd(a);e.onError(a)}})},_initLayer:function(a){this.loaded&&this._removeInternalLayers();this.name=a.name;this.description=a.description;this.snippet=a.snippet;this.visibility=a.visibility;this.featureInfos=a.featureInfos;var b,e,g=this.folders=a.folders,c=[],m;if(g){e=g.length;for(b=0;b<e;b++)m=g[b]=new v(g[b]),-1===m.parentFolderId&&c.push(m)}var g=this._links=a.networkLinks,d;e=g?g.length:0;for(b=0;b<e;b++)g[b].viewRefreshMode&&
-1!==g[b].viewRefreshMode.toLowerCase().indexOf("onregion")||(d=h.mixin({},this._options),d.linkInfo=g[b],d.id&&(d.id=d.id+"_"+b),g[b]=new w(g[b].href,d),g[b]._parentLayer=this,g[b]._parentFolderId=this._getLinkParentId(g[b].linkInfo.id));if((g=a.groundOverlays)&&0<g.length){d=h.mixin({},this._options);d.id&&(d.id+="_mapImage");m=this._groundLyr=new F(d);e=g.length;for(b=0;b<e;b++)m.addImage(new z(g[b]))}if((a=h.getObject("featureCollection.layers",!1,a))&&0<a.length)this._fLayers=[],s.forEach(a,
function(a,b){var e=h.getObject("featureSet.features",!1,a);e&&0<e.length&&(d=h.mixin({outFields:["*"],infoTemplate:a.popupInfo?new x(a.popupInfo):null,editable:!1},this._options),d.id&&(d.id=d.id+"_"+b),a.layerDefinition.capabilities="Query,Data",e=new A(a,d),e.geometryType&&(this["_"+e.geometryType]=e),this._fLayers.push(e))},this),0===this._fLayers.length&&delete this._fLayers;e=c.length;for(b=0;b<e;b++)m=c[b],this._setState(m,m.visible);this._fireUpdateEnd();this.loaded?(this._addInternalLayers(),
this.onRefresh()):(this.loaded=!0,this.onLoad(this))},_addInternalLayers:function(){var a=this._map;this._fireUpdateStart();this._links&&s.forEach(this._links,function(b){b.declaredClass&&(a.addLayer(b),b._waitingForMap&&(b._waitingForMap=null,b.visible?b._parseKml(a):b._wMap=a))});var b=a.spatialReference,g=this._outSR,c;if(!b.equals(g))if(b.isWebMercator()&&4326===g.wkid)c=e.geographicToWebMercator;else if(g.isWebMercator()&&4326===b.wkid)c=e.webMercatorToGeographic;else{console.log("KMLLayer:_setMap - unsupported workflow. Spatial reference of the map and kml layer do not match, and the conversion cannot be done on the client.");
return}this._groundLyr&&(c&&s.forEach(this._groundLyr.getImages(),function(a){a.extent=c(a.extent)}),a.addLayer(this._groundLyr));(b=this._fLayers)&&0<b.length&&s.forEach(b,function(b){if(c){var e=b.graphics,g,m,d=e?e.length:0;for(g=0;g<d;g++)(m=e[g].geometry)&&e[g].setGeometry(c(m))}a.addLayer(b)});this.onVisibilityChange(this.visible)},_removeInternalLayers:function(){var a=this._map;this._links&&s.forEach(this._links,function(a){a.declaredClass&&a._io&&a._io.cancel()});a&&s.forEach(this.getLayers(),
a.removeLayer,a)},_setState:function(a,b){var e=a.featureInfos,g,c,m,d=e?e.length:0,f=b?"show":"hide";for(m=0;m<d;m++)if(g=e[m],c=this.getFeature(g))if("Folder"===g.type)this._setState(c,b&&c.visible);else if("NetworkLink"===g.type)this._setInternalVisibility(c,b);else c[f]()},_areLocalAncestorsVisible:function(a){var b=a.parentFolderId;for(a=a.visible;a&&-1!==b;)b=this.getFeature({type:"Folder",id:b}),a=a&&b.visible,b=b.parentFolderId;return a},_setInternalVisibility:function(a,b){var e=a._parentLayer,
g=a._parentFolderId;for(b=b&&a.visible;b&&e;)b=b&&e.visible,-1<g&&(b=b&&e._areLocalAncestorsVisible(e.getFeature({type:"Folder",id:g}))),g=e._parentFolderId,e=e._parentLayer;this._setIntState(a,b)},_setIntState:function(a,b){a&&s.forEach(a.getLayers(),function(e){e.linkInfo?a._setIntState(e,b&&e.visible&&a._areLocalAncestorsVisible(a.getFeature({type:"Folder",id:e._parentFolderId}))):e.setVisibility(b)})},_getLinkParentId:function(a){var b=-1;this.folders&&s.some(this.folders,function(e){return e.networkLinkIds&&
-1!==s.indexOf(e.networkLinkIds,a)?(b=e.id,!0):!1});return b},_checkAutoRefresh:function(){var a=this.linkInfo;if(a)if(this.visible){if(this.loaded&&this._map){var b=a.refreshMode,e=a.refreshInterval,g=a.viewRefreshMode,a=a.viewRefreshTime;b&&(-1!==b.toLowerCase().indexOf("oninterval")&&0<e)&&(this._stopAutoRefresh(),this._timeoutHandle=setTimeout(this.refresh,1E3*e));g&&(-1!==g.toLowerCase().indexOf("onstop")&&0<a)&&!this._extChgHandle&&(this._extChgHandle=q.connect(this._map,"onExtentChange",this,
this._extentChanged))}}else this._stopAutoRefresh(),q.disconnect(this._extChgHandle),delete this._extChgHandle},_stopAutoRefresh:function(){clearTimeout(this._timeoutHandle);this._timeoutHandle=null},_getQueryParameters:function(a){a=a||this._map;var b={},g=this.linkInfo,c=a&&a.extent,d;this._url.query&&(h.mixin(b,this._url.query),d=!!this._url.query.token);if(m.id&&!d&&(d=m.id.findCredential(this._url.path)))b.token=d.token;if(g){d=g.viewFormat;var f=g.httpQuery,g=g.viewBoundScale;if(c&&d){var k=
c,n=c,q=c.spatialReference;q&&(q.isWebMercator()?k=e.webMercatorToGeographic(c):4326===q.wkid&&(n=e.geographicToWebMercator(c)));c=k.getCenter();n=Math.max(n.getWidth(),n.getHeight());g&&(k=k.expand(g));d=d.replace(/\[bboxWest\]/ig,k.xmin).replace(/\[bboxEast\]/ig,k.xmax).replace(/\[bboxSouth\]/ig,k.ymin).replace(/\[bboxNorth\]/ig,k.ymax).replace(/\[lookatLon\]/ig,c.x).replace(/\[lookatLat\]/ig,c.y).replace(/\[lookatRange\]/ig,n).replace(/\[lookatTilt\]/ig,0).replace(/\[lookatHeading\]/ig,0).replace(/\[lookatTerrainLon\]/ig,
c.x).replace(/\[lookatTerrainLat\]/ig,c.y).replace(/\[lookatTerrainAlt\]/ig,0).replace(/\[cameraLon\]/ig,c.x).replace(/\[cameraLat\]/ig,c.y).replace(/\[cameraAlt\]/ig,n).replace(/\[horizFov\]/ig,60).replace(/\[vertFov\]/ig,60).replace(/\[horizPixels\]/ig,a.width).replace(/\[vertPixels\]/ig,a.height).replace(/\[terrainEnabled\]/ig,0);h.mixin(b,p.queryToObject(d))}f&&(f=f.replace(/\[clientVersion\]/ig,m.version).replace(/\[kmlVersion\]/ig,2.2).replace(/\[clientName\]/ig,"ArcGIS API for JavaScript").replace(/\[language\]/ig,
l.locale),h.mixin(b,p.queryToObject(f)))}a=[];for(var v in b)r.isDefined(b[v])&&a.push(v+"\x3d"+b[v]);return(a=a.join("\x26"))?"?"+a:""},_setMap:function(a,b){this.inherited(arguments);this._map=a;var e=this._div=c.create("div",null,b);k.set(e,"position","absolute");this._addInternalLayers();this.evaluateSuspension();return e},_unsetMap:function(a,b){this._io&&this._io.cancel();this._stopAutoRefresh();q.disconnect(this._extChgHandle);delete this._extChgHandle;this._removeInternalLayers();var e=this._div;
e&&(b.removeChild(e),c.destroy(e));this._wMap=this._div=null;this.inherited(arguments)},onVisibilityChange:function(a){this.loaded?(this._fireUpdateStart(),this._setInternalVisibility(this,a),this._checkAutoRefresh(),this._fireUpdateEnd()):this.linkInfo&&a&&(this._waitingForMap||this._parseKml(this._wMap))},refresh:function(){this.loaded&&(this._map&&!this._io&&this.visible)&&this._parseKml()},_extentChanged:function(){this._stopAutoRefresh();this._timeoutHandle=setTimeout(this.refresh,1E3*this.linkInfo.viewRefreshTime)}});
d("extend-esri")&&h.setObject("layers.KMLLayer",w,m);return w})},"dojo/data/util/sorter":function(){define(["../../_base/lang"],function(l){var f={};l.setObject("dojo.data.util.sorter",f);f.basicComparator=function(f,h){var l=-1;null===f&&(f=void 0);null===h&&(h=void 0);if(f==h)l=0;else if(f>h||null==f)l=1;return l};f.createSortFunction=function(l,h){function s(b,a,g,e){return function(c,m){var d=e.getValue(c,b),f=e.getValue(m,b);return a*g(d,f)}}for(var n=[],d,p=h.comparatorMap,c=f.basicComparator,
k=0;k<l.length;k++){d=l[k];var m=d.attribute;if(m){d=d.descending?-1:1;var b=c;p&&("string"!==typeof m&&"toString"in m&&(m=m.toString()),b=p[m]||c);n.push(s(m,d,b,h))}}return function(b,a){for(var g=0;g<n.length;){var e=n[g++](b,a);if(0!==e)return e}return 0}};return f})},"esri/layers/OnDemandMode":function(){define("dojo/_base/declare dojo/_base/connect dojo/_base/lang dojo/_base/array dojo/has esri/kernel esri/geometry/Point esri/tasks/query esri/layers/RenderMode esri/layers/GridLayout".split(" "),
function(l,f,q,h,s,n,d,p,c,k){l=l([c],{declaredClass:"esri.layers._OnDemandMode",constructor:function(c){this.featureLayer=c;this._featureMap={};this._queryErrorHandler=q.hitch(this,this._queryErrorHandler)},initialize:function(c){this.inherited(arguments);var b=this.featureLayer,f=b._srInfo;this._gridLayer=new k(new d(f?f.valid[0]:c.extent.xmin,c.extent.ymax,c.spatialReference),{width:b._tileWidth,height:b._tileHeight},{width:c.width,height:c.height},f);this._cellMap={};this._gridLayer.setResolution(c.extent)},
startup:function(){this._ioQueue=[];this.featureLayer.suspended||(this._zoomHandler(),this._enableConnectors())},propertyChangeHandler:function(c){this._init&&(2>c?this._zoomHandler():console.log("FeatureLayer: layer in on-demand mode does not support time definitions. Layer id \x3d "+this.featureLayer.id+", Layer URL \x3d "+this.featureLayer.url))},destroy:function(){this._disableConnectors();this.inherited(arguments)},drawFeature:function(c){var b=this._gridLayer,d=c.geometry,a=[];if(d)for(var a=
b.getCellsInExtent("point"===d.type?{xmin:d.x,ymin:d.y,xmax:d.x,ymax:d.y}:d.getExtent(),!1).cells,b=this._cellMap,g,e=c.attributes[this.featureLayer.objectIdField],f,k,p,d=0;d<a.length;d++)g=a[d],f=g.latticeID,k=g.row,p=g.col,f?g=b[f]=b[f]||g:(b[k]=b[k]||{},g=b[k][p]=b[k][p]||g),g.features=g.features||[],g.features.push(c),this._addFeatureIIf(e,c),this._incRefCount(e)},suspend:function(){this._init&&this._disableConnectors()},resume:function(){this._init&&(this._enableConnectors(),this._zoomHandler())},
refresh:function(){this._zoomHandler()},_enableConnectors:function(){var c=this.map;this._zoomConnect=f.connect(c,"onZoomEnd",this,this._zoomHandler);this._panConnect=f.connect(c,"onPanEnd",this,this._panHandler);this._resizeConnect=f.connect(c,"onResize",this,this._panHandler)},_disableConnectors:function(){f.disconnect(this._zoomConnect);f.disconnect(this._panConnect);f.disconnect(this._resizeConnect)},_zoomHandler:function(){this._processIOQueue(!0);var c=this.featureLayer,b=this.map;c.suspended||
(c._fireUpdateStart(),this._clearIIf(),(c=c._trackManager)&&c.clearTracks(),this._cellMap={},this._gridLayer.setResolution(b.extent),this._sendRequest())},_panHandler:function(c){this.featureLayer._fireUpdateStart();this._sendRequest(this.featureLayer._resized&&c)},_getRequestId:function(c,b){return("_"+c.name+c.layerId+c._ulid+"_"+b.resolution+"_"+(b.latticeID||b.row+"_"+b.col)).replace(/[^a-zA-Z0-9\_]+/g,"_")},_sendRequest:function(c){this._exceeds=!1;var b=this.featureLayer,d=this.map;c=c||d.extent;
d=this._gridLayer.getCellsInExtent(c,b.latticeTiling).cells;if(!b.isEditable())var a=this._cellMap,d=h.filter(d,function(b){if(b.lattice){if(a[b.latticeID])return!1}else if(a[b.row]&&a[b.row][b.col])return!1;return!0});var g=b.getOutFields(),e=b.getDefinitionExpression(),f=b._getOffsettedTE(b._mapTimeExtent),k=b.supportsAdvancedQueries?b.orderByFields:null,n=b._usePatch,l=this._ioQueue,q,s=this,w=this._drawFeatures,u,t,D;this._pending=this._pending||0;for(q=0;q<d.length;q++){u=d[q];t=new p;t.geometry=
u.extent||u.lattice;t.outFields=g;t.where=e;b.latticeTiling&&u.extent&&(t.spatialRelationship=p.SPATIAL_REL_CONTAINS);t.returnGeometry=!0;t.timeExtent=f;t.maxAllowableOffset=b._maxOffset;b._ts&&(t._ts=(new Date).getTime());t.orderByFields=k;D=null;if(n&&(D=this._getRequestId(b,u),this._isPending(D)))continue;this._pending++;l.push(b._task.execute(t,function(){var a=u;return function(b){w.apply(s,[b,a])}}.call(this),this._queryErrorHandler,D))}this._removeOldCells(c);this._endCheck()},_drawFeatures:function(c,
b){this._exceeds=this._exceeds||c.exceededTransferLimit;this._finalizeIO();var d=this.map.extent,a=b.extent,g=b.row,e=b.col,f=this.featureLayer.objectIdField,k=c.features,p=this._gridLayer,h=this._cellMap,n=b.latticeID,l=n?h[n]:h[g]&&h[g][e];if(b.resolution!=p._resolution||(n?n!==p.getLatticeID(d):!p.intersects(a,d)))l&&this._removeCell(g,e,n);else if(l)this._updateCell(l,k);else{b.features=k;n?h[n]=b:(h[g]=h[g]||{},h[g][e]=b);a=k.length;for(d=0;d<a;d++)g=k[d],e=g.attributes[f],this._addFeatureIIf(e,
g),this._incRefCount(e)}this._endCheck()},_queryErrorHandler:function(c){this._finalizeIO();this.featureLayer._errorHandler(c);this._endCheck(!0)},_finalizeIO:function(){this._purgeRequests();this._pending--},_endCheck:function(c){if(0===this._pending){this._processIOQueue();var b=this.featureLayer,d=b._trackManager;d&&(d.clearTracks(),d.addFeatures(b.graphics),b._ager&&h.forEach(b.graphics,function(a){a._shape&&b._repaint(a)}),d.moveLatestToFront(),d.drawTracks());this.featureLayer._fireUpdateEnd(c&&
Error("FeatureLayer: an error occurred while updating the layer"),this._exceeds?{queryLimitExceeded:!0}:null);if(this._exceeds)b.onQueryLimitExceeded()}},_processIOQueue:function(c){this._ioQueue=h.filter(this._ioQueue,function(b){return-1<b.fired?!1:!0});c&&h.forEach(this._ioQueue,this._cancelPendingRequest)},_removeOldCells:function(c){var b=this._cellMap,d=this._gridLayer,a,g;for(a in b)if(b[a]){var e=b[a],f=e.latticeID,k=0,p=0;if(f)k++,f!==d.getLatticeID(c)&&(this._removeCell(null,null,f),p++);
else for(g in e)e[g]&&(k++,d.intersects(e[g].extent,c)||(this._removeCell(a,g),p++));p===k&&delete b[a]}},_updateCell:function(c,b){var d=this.featureLayer,a=d.objectIdField,d=d._selectedFeatures,g,e=b.length;c.features=c.features||[];for(g=0;g<e;g++){var f=b[g],k=f.attributes[a],p=this._addFeatureIIf(k,f);p===f?(this._incRefCount(k),c.features.push(p)):k in d||(p.setGeometry(f.geometry),p.setAttributes(f.attributes))}},_removeCell:function(c,b,d){var a=this._cellMap,g=this.featureLayer,e=g.objectIdField,
f=d?a[d]:a[c]&&a[c][b];if(f){d?delete a[d]:delete a[c][b];c=f.features;for(b=0;b<c.length;b++)d=c[b].attributes[e],this._decRefCount(d),d in g._selectedFeatures||this._removeFeatureIIf(d)}}});s("extend-esri")&&q.setObject("layers._OnDemandMode",l,n);return l})},"esri/layers/FeatureLayer":function(){define("dojo/_base/declare dojo/_base/connect dojo/_base/lang dojo/_base/array dojo/_base/json dojo/_base/Deferred dojo/date/locale dojo/sniff dojo/io-query dojo/dom-construct dojo/i18n esri/kernel esri/lang esri/request esri/deferredUtils esri/SpatialReference esri/symbols/SimpleMarkerSymbol esri/symbols/SimpleLineSymbol esri/symbols/SimpleFillSymbol esri/symbols/jsonUtils esri/renderers/SimpleRenderer esri/renderers/UniqueValueRenderer esri/renderers/jsonUtils esri/tasks/QueryTask esri/tasks/query esri/tasks/FeatureSet esri/geometry/Extent esri/geometry/jsonUtils esri/geometry/normalizeUtils esri/layers/GraphicsLayer esri/layers/Field esri/layers/TimeInfo esri/layers/FeatureType esri/layers/FeatureTemplate esri/layers/FeatureEditResult esri/layers/LabelClass esri/layers/SnapshotMode esri/layers/OnDemandMode esri/layers/SelectionMode esri/layers/TrackManager dojo/i18n!esri/nls/jsapi dojo/has!extend-esri?esri/layers/agscommon".split(" "),
function(l,f,q,h,s,n,d,p,c,k,m,b,r,a,g,e,x,y,v,z,F,A,w,u,t,D,E,L,X,M,Y,G,Z,$,J,N,P,aa,ba,ca){l=l(M,{declaredClass:"esri.layers.FeatureLayer",invalidParams:"query contains one or more unsupported parameters",_eventMap:{"add-attachment-complete":["result"],"before-apply-edits":["adds","updates","deletes"],"delete-attachments-complete":["results"],"edits-complete":["adds","updates","deletes"],"query-attachment-infos-complete":["results"],"query-count-complete":["count"],"query-features-complete":["featureSet"],
"query-ids-complete":["objectIds"],"query-related-features-complete":["featureSets"],"selection-complete":["features","method"],"update-end":["error","info"]},constructor:function(b,e){this.i18n=m.getLocalization("esri","jsapi");this._outFields=e&&e.outFields;this._loadCallback=e&&e.loadCallback;var c=e&&e._usePatch;this._usePatch=null===c||void 0===c?!0:c;this._trackIdField=e&&e.trackIdField;this.objectIdField=e&&e.objectIdField;this._maxOffset=e&&e.maxAllowableOffset;this._optEditable=e&&e.editable;
this._optAutoGen=e&&e.autoGeneralize;this.editSummaryCallback=e&&e.editSummaryCallback;this.userId=e&&e.userId;this.userIsAdmin=e&&e.userIsAdmin;this.useMapTime=e&&e.hasOwnProperty("useMapTime")?!!e.useMapTime:!0;this.source=e&&e.source;this.gdbVersion=e&&e.gdbVersion;this.orderByFields=e&&e.orderByFields;this._selectedFeatures={};this._selectedFeaturesArr=[];this._newFeatures=[];this._deletedFeatures={};this._ulid=this._getUniqueId();c=this.constructor;switch(this.mode=r.isDefined(e&&e.mode)?e.mode:
c.MODE_ONDEMAND){case c.MODE_SNAPSHOT:this._mode=new P(this);this._isSnapshot=!0;break;case c.MODE_ONDEMAND:this._tileWidth=e&&e.tileWidth||512;this._tileHeight=e&&e.tileHeight||512;this._mode=new aa(this);this.latticeTiling=e&&e.latticeTiling;break;case c.MODE_SELECTION:this._mode=new ba(this),this._isSelOnly=!0}this._initLayer=q.hitch(this,this._initLayer);this._selectHandler=q.hitch(this,this._selectHandler);this._editable=!1;if(q.isObject(b)&&b.layerDefinition)return this._collection=!0,this.mode=
c.MODE_SNAPSHOT,this._initLayer(b),this;this._task=new u(this.url,{source:this.source,gdbVersion:this.gdbVersion});c=this._url.path;this._fserver=!1;-1!==c.search(/\/FeatureServer\//i)&&(this._fserver=!0);var g=e&&e.resourceInfo;g?this._initLayer(g):(this.source&&(g={source:this.source.toJson()},this._url.query=q.mixin(this._url.query,{layer:s.toJson(g)})),this.gdbVersion&&(this._url.query=q.mixin(this._url.query,{gdbVersion:this.gdbVersion})),a({url:c,content:q.mixin({f:"json"},this._url.query),
callbackParamName:"callback",load:this._initLayer,error:this._errorHandler}));this.registerConnectEvents()},_initLayer:function(a,b){if(a||b){this._json=a;this._findCredential();if(this.credential&&this.credential.ssl||a&&a._ssl)this._useSSL(),this._task._useSSL();this._collection&&(this._mode=new P(this),this._isSnapshot=!0,this._featureSet=a.featureSet,this._nextId=a.nextObjectId,a=a.layerDefinition);if(a.hasOwnProperty("capabilities")){var c=this.capabilities=a.capabilities;c&&-1!==c.toLowerCase().indexOf("editing")?
this._editable=!0:this._editable=!1}else this._collection||(this._editable=this._fserver);r.isDefined(this._optEditable)&&(this._editable=this._optEditable,delete this._optEditable);this._json=s.toJson(this._json);if(this.isEditable())delete this._maxOffset;else if(this.mode!==this.constructor.MODE_SNAPSHOT&&("esriGeometryPolyline"===a.geometryType||"esriGeometryPolygon"===a.geometryType))this._autoGeneralize=r.isDefined(this._optAutoGen)?this._optAutoGen:this.mode===this.constructor.MODE_ONDEMAND,
delete this._optAutoGen;var c=a.effectiveMinScale||a.minScale,g=a.effectiveMaxScale||a.maxScale;!this._hasMin&&c&&this.setMinScale(c);!this._hasMax&&g&&this.setMaxScale(g);this.layerId=a.id;this.name=a.name;this.description=a.description;this.copyright=a.copyrightText;this.type=a.type;this.geometryType=a.geometryType;this.displayField=a.displayField;this.defaultDefinitionExpression=a.definitionExpression;this.fullExtent=new E(a.extent);this.initialExtent=new E(this.fullExtent.toJson());this.fullExtent.spatialReference&&
(this.spatialReference=new e(this.fullExtent.spatialReference.toJson()));this.defaultVisibility=a.defaultVisibility;if("esriGeometryPoint"===this.geometryType||"esriGeometryMultipoint"===this.geometryType)this.latticeTiling=!1;this.indexedFields=a.indexedFields;this.maxRecordCount=a.maxRecordCount;this.canModifyLayer=a.canModifyLayer;this.supportsStatistics=a.supportsStatistics;this.supportsAdvancedQueries=a.supportsAdvancedQueries;this.hasLabels=a.hasLabels;this.canScaleSymbols=a.canScaleSymbols;
this.supportsRollbackOnFailure=a.supportsRollbackOnFailure;this.syncCanReturnChanges=a.syncCanReturnChanges;this.isDataVersioned=a.isDataVersioned;this.editFieldsInfo=a.editFieldsInfo;this.ownershipBasedAccessControlForFeatures=a.ownershipBasedAccessControlForFeatures;this.editFieldsInfo&&this.ownershipBasedAccessControlForFeatures&&(this.creatorField=this.editFieldsInfo.creatorField);this.relationships=a.relationships;this.allowGeometryUpdates=r.isDefined(a.allowGeometryUpdates)?a.allowGeometryUpdates:
!0;this._isTable="Table"===this.type;for(var d=this.fields=[],g=a.fields,c=0;c<g.length;c++)d.push(new Y(g[c]));if(!this.objectIdField){this.objectIdField=a.objectIdField;if(!this.objectIdField){g=a.fields;for(c=0;c<g.length;c++)if(d=g[c],"esriFieldTypeOID"===d.type){this.objectIdField=d.name;break}}this.objectIdField||console.debug("esri.layers.FeatureLayer: "+r.substitute({url:this.url},"objectIdField is not set [url: ${url}]"))}if(!r.isDefined(this._nextId)){g=this.objectIdField;d=-1;if(this._collection&&
g)for(var f=(c=this._featureSet)&&c.features,k=f?f.length:0,m,c=0;c<k;c++)m=(m=f[c].attributes)&&m[g],m>d&&(d=m);this._nextId=d+1}this.globalIdField=a.globalIdField;if(c=this.typeIdField=a.typeIdField)if(c=!this._getField(c)&&this._getField(c,!0))this.typeIdField=c.name;this.visibilityField=a.visibilityField;if(g=a.defaultSymbol)this.defaultSymbol=z.fromJson(g);var n=this.types=[],l=a.types,H,u,d=(c=this.editFieldsInfo)&&c.creatorField,f=c&&c.editorField;m=d||f;k=[];if(l)for(c=0;c<l.length;c++)H=
new Z(l[c]),u=H.templates,m&&(u&&u.length)&&(k=k.concat(u)),n.push(H);l=a.templates;H=this.templates=[];if(l)for(c=0;c<l.length;c++)n=new $(l[c]),m&&k.push(n),H.push(n);for(c=0;c<k.length;c++)if(m=q.getObject("prototype.attributes",!1,k[c]))d&&delete m[d],f&&delete m[f];if(c=a.timeInfo)this.timeInfo=new G(c),this._startTimeField=c.startTimeField,this._endTimeField=c.endTimeField,this._startTimeField&&this._endTimeField&&(this._twoTimeFields=!0),this._trackIdField?c.trackIdField=this._trackIdField:
this._trackIdField=c.trackIdField;this.hasAttachments=!this._collection&&a.hasAttachments?!0:!1;this.htmlPopupType=a.htmlPopupType;var c=a.drawingInfo,t;if(d=c&&c.labelingInfo)this.labelingInfo=h.map(d,function(a){return new N(a)});if(!this.renderer)if(c&&c.renderer){if(t=c.renderer,this.setRenderer(w.fromJson(t)),"classBreaks"===t.type&&this.renderer.setMaxInclusive(!0),!this._collection){var B=t.type,g=[];t=this.renderer;switch(B){case "simple":g.push(t.symbol);break;case "uniqueValue":case "classBreaks":g.push(t.defaultSymbol),
g=g.concat(h.map(t.infos,function(a){return a.symbol}))}var g=h.filter(g,r.isDefined),L=this._url.path+"/images/",M=this._getToken();h.forEach(g,function(a){var b=a.url;b&&(-1===b.search(/https?\:/)&&-1===b.indexOf("data:")&&(a.url=L+b),M&&-1!==a.url.search(/https?\:/)&&(a.url+="?token\x3d"+M))})}}else if(g)l=this.types,0<l.length?(t=new A(this.defaultSymbol,this.typeIdField),h.forEach(l,function(a){t.addValue(a.id,a.symbol)})):t=new F(this.defaultSymbol),this.setRenderer(t);else if(!this._isTable){switch(this.geometryType){case "esriGeometryPoint":case "esriGeometryMultipoint":B=
new x;break;case "esriGeometryPolyline":B=new y;break;case "esriGeometryPolygon":B=new v}this.setRenderer(B?new F(B):null)}B=c&&c.transparency||0;!r.isDefined(this.opacity)&&0<B&&(this.opacity=1-B/100);this.version=a.currentVersion;this.version||(this.version="capabilities"in a||"drawingInfo"in a||"hasAttachments"in a||"htmlPopupType"in a||"relationships"in a||"timeInfo"in a||"typeIdField"in a||"types"in a?10:9.3);if((p("ie")||p("safari"))&&this.isEditable()&&10.02>this.version)this._ts=!0;this.loaded=
!0;this._fixRendererFields();this._checkFields();this._updateCaps();B=function(){this.onLoad(this);var a=this._loadCallback;a&&(delete this._loadCallback,a(this))};this._collection?(this._fireUpdateStart(),c=this._featureSet,delete this._featureSet,this._mode._drawFeatures(new D(c)),this._fcAdded=!0,B.call(this)):this._forceIdentity(B)}},onRendererChange:function(){this.inherited(arguments);var a=this._getRenderer();this._ager=!(!a||!a.observationAger||!a.observationRenderer);if(a){var b=[],a=h.filter([a,
a.observationRenderer,a.latestObservationRenderer,a.trackRenderer],r.isDefined);h.forEach(a,function(a){q.isFunction(a.attributeField)||b.push(a.attributeField);b.push(a.attributeField2);b.push(a.attributeField3)},this);this._rendererFields=h.filter(b,r.isDefined)}else this._rendererFields=[];this.loaded&&(0<this._rendererFields.length&&(this._fixRendererFields(),this._checkFields(this._rendererFields)),this._collection&&(this._typesDirty=!0))},redraw:function(){this.inherited(arguments);this._trackManager&&
this._trackManager.container&&this._trackManager.container.redraw()},_evalSDRenderer:function(){this.inherited(arguments);var a=this._getRenderer();this._ager=!(!a||!a.observationAger||!a.observationRenderer);this._trackManager&&this._trackManager.container&&this._trackManager.container.setRenderer(a&&a.trackRenderer)},_setMap:function(a){var b=this.inherited(arguments),c=this._mode,e=this;c&&c.initialize(a);this.geometryType&&this.attr("data-geometry-type",this.geometryType.replace(/esriGeometry/i,
"").toLowerCase());this._addHandle=this.on("graphic-node-add",function(a){a=a.graphic.attributes;(a=e._selectedFeatures[a&&a[e.objectIdField]])&&a.attr("data-selected","")});return b},_unsetMap:function(a){var b=this._mode;b&&b.suspend();this._trackManager&&(this._trackManager.destroy(),this._trackManager=null);f.disconnect(this._zoomConnect);f.disconnect(this._addHandle);this._zoomConnect=this._addHandle=null;this._toggleTime(!1);this.inherited("_unsetMap",arguments)},refresh:function(){var a=this._mode;
a&&a.refresh()},getOutFields:function(){return h.filter(this._getOutFields(),function(a){return"*"===a||!!this._getField(a)},this)},setEditable:function(a){if(!this._collection)return console.log("FeatureLayer:setEditable - this functionality is not yet supported for layer in a feature service"),this;if(!this.loaded)return this._optEditable=a,this;var b=this._editable;this._editable=a;this._updateCaps();if(b!==a)this.onCapabilitiesChange();return this},getEditCapabilities:function(a){var b={canCreate:!1,
canUpdate:!1,canDelete:!1};if(!this.loaded||!this.isEditable())return b;var c=a&&a.feature;a=a&&a.userId;var e=h.map(this.capabilities?this.capabilities.toLowerCase().split(","):[],q.trim),g=-1<h.indexOf(e,"editing"),d=g&&-1<h.indexOf(e,"create"),b=g&&-1<h.indexOf(e,"update"),e=g&&-1<h.indexOf(e,"delete"),f=this.ownershipBasedAccessControlForFeatures,k=this.editFieldsInfo,m=k&&k.creatorField,k=k&&k.realm,c=(c=c&&c.attributes)&&m?c[m]:void 0,p=!!this.userIsAdmin,m=!f||p||!(!f.allowOthersToUpdate&&
!f.allowUpdateToOthers),f=!f||p||!(!f.allowOthersToDelete&&!f.allowDeleteToOthers);if(p||g&&!d&&!b&&!e)d=b=e=!0;g={canCreate:d,canUpdate:b,canDelete:e};null===c?(g.canUpdate=b&&m,g.canDelete=e&&f):""!==c&&c&&((a=a||this.getUserId())&&k&&(a=a+"@"+k),a.toLowerCase()!==c.toLowerCase()&&(g.canUpdate=b&&m,g.canDelete=e&&f));return g},getUserId:function(){var a;this.loaded&&(a=this.credential&&this.credential.userId||this.userId||"");return a},setUserIsAdmin:function(a){this.userIsAdmin=a},setEditSummaryCallback:function(a){this.editSummaryCallback=
a},getEditSummary:function(a,b,c){c=r.isDefined(c)?c:(new Date).getTime();var e="";c=this.getEditInfo(a,b,c);(b=b&&b.callback||this.editSummaryCallback)&&(c=b(a,c)||"");if(q.isString(c))e=c;else{if(c){a=c.action;b=c.userId;var g=c.timeValue,d=0;a&&d++;b&&d++;r.isDefined(g)&&d++;1<d&&(e=("edit"===a?"edit":"create")+(b?"User":"")+(r.isDefined(g)?c.displayPattern:""))}e=e&&r.substitute(c,this.i18n.layers.FeatureLayer[e])}return e},getEditInfo:function(a,b,c){if(this.loaded){c=r.isDefined(c)?c:(new Date).getTime();
b=b&&b.action||"last";var e=this.editFieldsInfo,g=e&&e.creatorField,d=e&&e.creationDateField,f=e&&e.editorField,e=e&&e.editDateField,f=(a=a&&a.attributes)&&f?a[f]:void 0,e=a&&e?a[e]:null,g=this._getEditData(a&&g?a[g]:void 0,a&&d?a[d]:null,c);c=this._getEditData(f,e,c);var k;switch(b){case "creation":k=g;break;case "edit":k=c;break;case "last":k=c||g}k&&(k.action=k===c?"edit":"creation");return k}},_getEditData:function(a,b,c){var e,g,f;r.isDefined(b)&&(g=c-b,f=0>g?"Full":6E4>g?"Seconds":12E4>g?"Minute":
36E5>g?"Minutes":72E5>g?"Hour":864E5>g?"Hours":6048E5>g?"WeekDay":"Full");if(void 0!==a||f)e=e||{},e.userId=a,f&&(a=d.format,c=new Date(b),e.minutes=Math.floor(g/6E4),e.hours=Math.floor(g/36E5),e.weekDay=a(c,{datePattern:"EEEE",selector:"date"}),e.formattedDate=a(c,{selector:"date"}),e.formattedTime=a(c,{selector:"time"}),e.displayPattern=f,e.timeValue=b);return e},isEditable:function(){return!(!this._editable&&!this.userIsAdmin)},setMaxAllowableOffset:function(a){this.isEditable()||(this._maxOffset=
a);return this},getMaxAllowableOffset:function(){return this._maxOffset},setAutoGeneralize:function(a){if(this.loaded){if(!this.isEditable()&&this.mode!==this.constructor.MODE_SNAPSHOT&&("esriGeometryPolyline"===this.geometryType||"esriGeometryPolygon"===this.geometryType))if(this._autoGeneralize=a){if((a=this._map)&&a.loaded)this._maxOffset=Math.floor(a.extent.getWidth()/a.width)}else delete this._maxOffset}else this._optAutoGen=a;return this},setGDBVersion:function(a){if(!this._collection&&a!==
this.gdbVersion&&(a||this.gdbVersion))this.gdbVersion=a,this._task.gdbVersion=a,this._url.query=q.mixin(this._url.query,{gdbVersion:a}),this.loaded&&(this.clearSelection(),this._map&&this.refresh()),this.onGDBVersionChange();return this},setDefinitionExpression:function(a){this._defnExpr=a;(a=this._mode)&&a.propertyChangeHandler(1);return this},getDefinitionExpression:function(){return this._defnExpr},setTimeDefinition:function(a){this._isSnapshot?(this._timeDefn=a,(a=this._mode)&&a.propertyChangeHandler(2)):
console.log("FeatureLayer.setTimeDefinition: layer in on-demand or selection mode does not support time definitions. Layer id \x3d "+this.id+", Layer URL \x3d "+this.url);return this},getTimeDefinition:function(){return this._timeDefn},setTimeOffset:function(a,b){this._timeOffset=a;this._timeOffsetUnits=b;var c=this._mode;c&&c.propertyChangeHandler(0);return this},setUseMapTime:function(a){this.useMapTime=a;this._toggleTime(!this.suspended);(a=this._mode)&&a.propertyChangeHandler(0)},selectFeatures:function(a,
b,c,d){b=b||this.constructor.SELECTION_NEW;a=this._getShallowClone(a);var f=this._map,k=g._fixDfd(new n(g._dfdCanceller));a.outFields=this.getOutFields();a.returnGeometry=!0;f&&(a.outSpatialReference=new e(f.spatialReference.toJson()));if(!this._applyQueryFilters(a,!0))return a={features:[]},this._selectHandler(a,b,c,d,k),k;if(f=this._canDoClientSideQuery(a))a={features:this._doQuery(a,f)},this._selectHandler(a,b,c,d,k);else{if(this._collection)return this._resolve([Error("FeatureLayer::selectFeatures - "+
this.invalidParams)],null,d,k,!0),k;var m=this;this._ts&&(a._ts=(new Date).getTime());(k._pendingDfd=this._task.execute(a)).addCallbacks(function(a){m._selectHandler(a,b,c,d,k)},function(a){m._resolve([a],null,d,k,!0)})}return k},getSelectedFeatures:function(){var a=this._selectedFeatures,b=[],c;for(c in a)a.hasOwnProperty(c)&&b.push(a[c]);return b},clearSelection:function(a){var b=this._selectedFeatures,c=this._mode,e;for(e in b)b.hasOwnProperty(e)&&(this._unSelectFeatureIIf(e,c),c._removeFeatureIIf(e));
this._selectedFeatures={};this._isSelOnly&&c._applyTimeFilter(!0);if(!a)this.onSelectionClear();return this},setSelectionSymbol:function(a){if(this._selectionSymbol=a){var b=this._selectedFeatures,c;for(c in b)b.hasOwnProperty(c)&&b[c].setSymbol(a)}return this},getSelectionSymbol:function(){return this._selectionSymbol},__msigns:[{n:"applyEdits",c:5,a:[{i:0},{i:1}],e:4,f:1}],applyEdits:function(b,c,e,g,d,f){var k=f.assembly,m=f.dfd;this._applyNormalized(b,k&&k[0]);this._applyNormalized(c,k&&k[1]);
this.onBeforeApplyEdits(b,c,e);var p={},n=this.objectIdField,k={f:"json"},l=!1;if(this._collection)f={},f.addResults=b?h.map(b,function(){l=!0;return{objectId:this._nextId++,success:!0}},this):null,f.updateResults=c?h.map(c,function(a){l=!0;var b=a.attributes[n];p[b]=a;return{objectId:b,success:!0}},this):null,f.deleteResults=e?h.map(e,function(a){l=!0;return{objectId:a.attributes[n],success:!0}},this):null,l&&this._editHandler(f,b,p,g,d,m);else{b&&0<b.length&&(k.adds=this._convertFeaturesToJson(b,
0,1),l=!0);if(c&&0<c.length){for(f=0;f<c.length;f++){var r=c[f];p[r.attributes[n]]=r}k.updates=this._convertFeaturesToJson(c,0,0,1);l=!0}if(e&&0<e.length){c=[];for(f=0;f<e.length;f++)c.push(e[f].attributes[n]);k.deletes=c.join(",");l=!0}if(l){var s=this;return a({url:this._url.path+"/applyEdits",content:q.mixin(k,this._url.query),callbackParamName:"callback",load:function(a){s._editHandler(a,b,p,g,d,m)},error:function(a){s._resolve([a],null,d,m,!0)}},{usePost:!0})}}},queryFeatures:function(a,b,c){return this._query("execute",
"onQueryFeaturesComplete",a,b,c)},queryRelatedFeatures:function(a,b,c){return this._query("executeRelationshipQuery","onQueryRelatedFeaturesComplete",a,b,c)},queryIds:function(a,b,c){return this._query("executeForIds","onQueryIdsComplete",a,b,c)},queryCount:function(a,b,c){return this._query("executeForCount","onQueryCountComplete",a,b,c)},queryAttachmentInfos:function(b,e,d){var f=this._url.path+"/"+b+"/attachments",k=new n(g._dfdCanceller),m=this;k._pendingDfd=a({url:f,content:q.mixin({f:"json"},
this._url.query),callbackParamName:"callback",load:function(a){a=a.attachmentInfos;var g;h.forEach(a,function(a){g=c.objectToQuery({gdbVersion:m._url.query&&m._url.query.gdbVersion,layer:m._url.query&&m._url.query.layer,token:m._getToken()});a.url=f+"/"+a.id+(g?"?"+g:"");a.objectId=b});m._resolve([a],"onQueryAttachmentInfosComplete",e,k)},error:function(a){m._resolve([a],null,d,k,!0)}});return k},addAttachment:function(a,b,c,e){return this._sendAttachment("add",a,b,c,e)},updateAttachment:function(a,
b,c,e,g){c.appendChild(k.create("input",{type:"hidden",name:"attachmentId",value:b}));return this._sendAttachment("update",a,c,e,g)},deleteAttachments:function(b,c,e,d){var f=this._url.path+"/"+b+"/deleteAttachments",k=new n(g._dfdCanceller),m=this;c={f:"json",attachmentIds:c.join(",")};k._pendingDfd=a({url:f,content:q.mixin(c,this._url.query),callbackParamName:"callback",load:q.hitch(this,function(a){a=a.deleteAttachmentResults;a=h.map(a,function(a){a=new J(a);a.attachmentId=a.objectId;a.objectId=
b;return a});m._resolve([a],"onDeleteAttachmentsComplete",e,k)}),error:function(a){m._resolve([a],null,d,k,!0)}},{usePost:!0});return k},addType:function(a){var b=this.types;if(b){if(h.some(b,function(b){return b.id==a.id?!0:!1}))return!1;b.push(a)}else this.types=[a];return this._typesDirty=!0},deleteType:function(a){if(this._collection){var b=this.types;if(b){var c=-1;h.some(b,function(b,e){return b.id==a?(c=e,!0):!1});if(-1<c)return this._typesDirty=!0,b.splice(c,1)[0]}}},toJson:function(){var a=
this._json;if(a=q.isString(a)?s.fromJson(a):q.clone(a)){var a=a.layerDefinition?a:{layerDefinition:a},b=a.layerDefinition,c=this._collection;if(c&&this._typesDirty){b.types=h.map(this.types||[],function(a){return a.toJson()});var e=this.renderer,g=b.drawingInfo;e&&!g&&(g=b.drawingInfo={});g&&(e&&-1===e.declaredClass.indexOf("TemporalRenderer"))&&(g.renderer=e.toJson())}e=null;if(!c||this._fcAdded)e={geometryType:b.geometryType,features:this._convertFeaturesToJson(this.graphics,!0)};a.featureSet=q.mixin({},
a.featureSet||{},e);c&&(a.nextObjectId=this._nextId,b.capabilities=this.capabilities);return a}},onSelectionComplete:function(){},onSelectionClear:function(){},onBeforeApplyEdits:function(){},onEditsComplete:function(){},onQueryFeaturesComplete:function(){},onQueryRelatedFeaturesComplete:function(){},onQueryIdsComplete:function(){},onQueryCountComplete:function(){},onQueryAttachmentInfosComplete:function(){},onAddAttachmentComplete:function(){},onUpdateAttachmentComplete:function(){},onDeleteAttachmentsComplete:function(){},
onCapabilitiesChange:function(){},onGDBVersionChange:function(){},onQueryLimitExceeded:function(){},_forceIdentity:function(a){var c=this,e=this._url&&this._url.path;(this.ownershipBasedAccessControlForFeatures||this.userIsAdmin)&&!this._getToken()&&e&&b.id&&b.id._hasPortalSession()&&b.id._doPortalSignIn(e)?b.id.getCredential(e).then(function(){c._findCredential();a.call(c)},function(){a.call(c)}):a.call(this)},_updateCaps:function(){var a=this._editable,b=q.trim(this.capabilities||""),c=h.map(b?
b.split(","):[],q.trim),e=h.map(b?b.toLowerCase().split(","):[],q.trim),b=h.indexOf(e,"editing"),g,e={Create:h.indexOf(e,"create"),Update:h.indexOf(e,"update"),Delete:h.indexOf(e,"delete")};if(a&&-1===b)c.push("Editing");else if(!a&&-1<b){a=[b];for(g in e)-1<e[g]&&a.push(e[g]);a.sort();for(g=a.length-1;0<=g;g--)c.splice(a[g],1)}this.capabilities=c.join(",")},_counter:{value:0},_getUniqueId:function(){return this._counter.value++},onSuspend:function(){this.inherited(arguments);this._toggleTime(!1);
var a=this._mode;a&&a.suspend()},onResume:function(a){this.inherited(arguments);this._toggleTime(!0);this._updateMaxOffset();var b=this._mode,c=this._map,e=this._getRenderer();if(a.firstOccurrence){this._fixRendererFields();this._checkFields();this.clearSelection();if(this.timeInfo&&(this._trackIdField||e&&(e.latestObservationRenderer||e.trackRenderer)))this._trackManager=new ca(this),this._trackManager.initialize(c);this._zoomConnect=f.connect(c,"onZoomEnd",this,this._updateMaxOffset)}b&&(a.firstOccurrence?
b.startup():b.resume())},_updateMaxOffset:function(){var a=this._map;a&&a.loaded&&this._autoGeneralize&&(this._maxOffset=Math.floor(a.extent.getWidth()/a.width))},_toggleTime:function(a){var b=this._map;a&&this.timeInfo&&this.useMapTime&&b?(this._mapTimeExtent=b.timeExtent,this._timeConnect||(this._timeConnect=f.connect(b,"onTimeExtentChange",this,this._timeChangeHandler))):(this._mapTimeExtent=null,f.disconnect(this._timeConnect),this._timeConnect=null)},_timeChangeHandler:function(a){this._mapTimeExtent=
a;(a=this._mode)&&a.propertyChangeHandler(0)},_getOffsettedTE:function(a){var b=this._timeOffset,c=this._timeOffsetUnits;return a&&b&&c?a.offset(-1*b,c):a},_getTimeOverlap:function(a,b){return a&&b?a.intersection(b):a||b},_getTimeFilter:function(a){var b=this.getTimeDefinition(),c;if(b&&(c=this._getTimeOverlap(b,null),!c))return[!1];if(a){if(a=c?this._getTimeOverlap(a,c):a,!a)return[!1]}else a=c;return[!0,a]},_getAttributeFilter:function(a){var b=this.getDefinitionExpression();return a?b?"("+b+") AND ("+
a+")":a:b},_applyQueryFilters:function(a,b){a.where=this._getAttributeFilter(a.where);a.maxAllowableOffset=this._maxOffset;b&&this.supportsAdvancedQueries&&(a.orderByFields=a.orderByFields||this.orderByFields);if(this.timeInfo){var c=this._getTimeFilter(a.timeExtent);if(c[0])a.timeExtent=c[1];else return!1}return!0},_add:function(a){var b=this._selectionSymbol,c=a.attributes,e=this.visibilityField;b&&this._isSelOnly&&a.setSymbol(b);if(e&&c&&c.hasOwnProperty(e))a[c[e]?"show":"hide"]();return this.add.apply(this,
arguments)},_remove:function(){return this.remove.apply(this,arguments)},_canDoClientSideQuery:function(a){var b=[],c=this._map;if(!this._isTable&&c&&!a.text&&!(a.where&&a.where!==this.getDefinitionExpression()||a.orderByFields&&a.orderByFields.length)){var e=this._isSnapshot,g=this._isSelOnly,d=a.geometry;if(d)if(!g&&a.spatialRelationship===t.SPATIAL_REL_INTERSECTS&&"extent"===d.type&&(e||c.extent.contains(d)))b.push(1);else return;if(c=a.objectIds)if(e)b.push(2);else{var d=c.length,f=this._mode,
k=0,m;for(m=0;m<d;m++)f._getFeature(c[m])&&k++;if(k===d)b.push(2);else return}if(this.timeInfo)if(a=a.timeExtent,c=this._mapTimeExtent,e)a&&b.push(3);else if(g){if(a)return}else if(c)if(-1!==h.indexOf(b,2))a&&b.push(3);else return;else if(0<b.length)a&&b.push(3);else if(a)return;return 0<b.length?b:null}},_doQuery:function(a,b,c){var e=[],g=this._mode,d=this.objectIdField,f,k;if(-1!==h.indexOf(b,2)){var e=[],m=a.objectIds;k=m.length;for(f=0;f<k;f++){var p=g._getFeature(m[f]);p&&e.push(p)}if(0===e.length)return[]}if(-1!==
h.indexOf(b,1)){g=0<e.length?e:this.graphics;k=g.length;m=a.geometry._normalize(null,!0);e=[];for(f=0;f<k;f++){var p=g[f],l=p.geometry;l&&(this.normalization&&m.length?(m[0].intersects(l)||m[1].intersects(l))&&e.push(p):m.intersects(l)&&e.push(p))}if(0===e.length)return[]}-1!==h.indexOf(b,3)&&this.timeInfo&&(g=0<e.length?e:this.graphics,a=a.timeExtent,e=this._filterByTime(g,a.startTime,a.endTime).match);return c?h.map(e,function(a){return a.attributes[d]},this):e},_filterByTime:function(a,b,c){var e=
this._startTimeField,g=this._endTimeField,d;this._twoTimeFields||(d=e||g);var f=r.isDefined,k=[],m=[],p,h=a.length,l,n;b=b?b.getTime():-Infinity;c=c?c.getTime():Infinity;if(d)for(p=0;p<h;p++)l=a[p],n=l.attributes,e=n[d],e>=b&&e<=c?k.push(l):m.push(l);else for(p=0;p<h;p++)l=a[p],n=l.attributes,d=n[e],n=n[g],d=f(d)?d:-Infinity,n=f(n)?n:Infinity,d>=b&&d<=c||n>=b&&n<=c||b>=d&&c<=n?k.push(l):m.push(l);return{match:k,noMatch:m}},_resolve:function(a,b,c,e,d){b&&this[b].apply(this,a);c&&c.apply(null,a);e&&
g._resDfd(e,a,d)},_getShallowClone:function(a){var b=new t,c;for(c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b},_query:function(a,b,c,d,f){var k=this,m=this._map,p=new n(g._dfdCanceller),h=c,l=function(c,e){if(!e&&"execute"===a&&!k._isTable){var g=c.features,f=k._mode,m=k.objectIdField,h;for(h=g.length-1;0<=h;h--){var l=f._getFeature(g[h].attributes[m]);l&&g.splice(h,1,l)}}k._resolve([c],b,d,p)};if("executeRelationshipQuery"!==a){h=this._getShallowClone(c);h.outFields=this.getOutFields();h.returnGeometry=
c.hasOwnProperty("returnGeometry")?c.returnGeometry:!0;var r;m&&(h.outSpatialReference=new e(m.spatialReference.toJson()));if(!this._applyQueryFilters(h,"execute"===a)){switch(a){case "execute":r=new D({features:[]});break;case "executeForIds":r=[];break;case "executeForCount":r=0}l(r,!0);return p}if(c=this._canDoClientSideQuery(h)){h=this._doQuery(h,c,"executeForIds"===a||"executeForCount"===a);switch(a){case "execute":r=new D;r.features=h;break;case "executeForIds":r=h;break;case "executeForCount":r=
h.length}l(r,!0);return p}}if(this._collection)return this._resolve([Error("FeatureLayer::_query - "+this.invalidParams)],null,f,p,!0),p;this._ts&&(h._ts=(new Date).getTime());(p._pendingDfd=this._task[a](h)).addCallbacks(l,function(a){k._resolve([a],null,f,p,!0)});return p},_convertFeaturesToJson:function(a,b,c,e){var g=[],d=this._selectionSymbol,f=this.visibilityField,k,m=this.objectIdField;if(this.loaded&&(c||e))k=h.filter(this.fields,function(a){return!1===a.editable&&(!e||a.name!==m)});for(c=
0;c<a.length;c++){var p=a[c],l={},n=p.geometry,r=p.attributes,v=p.symbol;if(n&&(!e||!this.loaded||this.allowGeometryUpdates))l.geometry=n.toJson();f?(l.attributes=r=q.mixin({},r),r[f]=p.visible?1:0):r&&(l.attributes=q.mixin({},r));l.attributes&&(k&&k.length)&&h.forEach(k,function(a){delete l.attributes[a.name]});v&&v!==d&&(l.symbol=v.toJson());g.push(l)}return b?g:s.toJson(g)},_selectHandler:function(a,b,c,e,g){var d;e=this.constructor;switch(b){case e.SELECTION_NEW:this.clearSelection(!0);d=!0;break;
case e.SELECTION_ADD:d=!0;break;case e.SELECTION_SUBTRACT:d=!1}e=a.features;var f=this._mode,k=[],m=this.objectIdField,p,h;if(d)for(d=0;d<e.length;d++)p=e[d],h=p.attributes[m],p=f._addFeatureIIf(h,p),k.push(p),this._selectFeatureIIf(h,p,f);else for(d=0;d<e.length;d++)p=e[d],h=p.attributes[m],this._unSelectFeatureIIf(h,f),h=f._removeFeatureIIf(h),k.push(h||p);this._isSelOnly&&f._applyTimeFilter(!0);this._resolve([k,b,a.exceededTransferLimit?{queryLimitExceeded:!0}:null],"onSelectionComplete",c,g);
if(a.exceededTransferLimit)this.onQueryLimitExceeded()},_selectFeatureIIf:function(a,b,c){var e=this._selectedFeatures,g=e[a];g||(c._incRefCount(a),e[a]=b,this._isTable||(this._setSelectSymbol(b),b.attr("data-selected","")));return g||b},_unSelectFeatureIIf:function(a,b){var c=this._selectedFeatures[a];c&&(b._decRefCount(a),delete this._selectedFeatures[a],this._isTable||(this._setUnSelectSymbol(c),c.attr("data-selected")));return c},_isSelected:function(a){},_setSelectSymbol:function(a){var b=this._selectionSymbol;
b&&!this._isSelOnly&&a.setSymbol(b)},_setUnSelectSymbol:function(a){var b=this._selectionSymbol;b&&!this._isSelOnly&&b===a.symbol&&a.setSymbol(null,!0)},_getOutFields:function(){var a=[this.objectIdField,this.typeIdField,this.creatorField,this._startTimeField,this._endTimeField,this._trackIdField].concat(this._rendererFields).concat(this.dataAttributes),a=h.filter(a,function(a,b,c){return!!a&&h.indexOf(c,a)===b}),b=q.clone(this._outFields);if(b){if(-1!==h.indexOf(b,"*"))return b;h.forEach(a,function(a){-1===
h.indexOf(b,a)&&b.push(a)});return b}return a},_checkFields:function(a){var b=a||this._getOutFields();h.forEach(b,function(a){"*"!==a&&(this._getField(a)||console.debug("esri.layers.FeatureLayer: "+r.substitute({url:this.url,field:a},"unable to find '${field}' field in the layer 'fields' information [url: ${url}]")))},this);!a&&(!this._isTable&&!this._fserver&&!this._collection)&&(h.some(this.fields,function(a){return a&&"esriFieldTypeGeometry"===a.type?!0:!1})||console.debug("esri.layers.FeatureLayer: "+
r.substitute({url:this.url},"unable to find a field of type 'esriFieldTypeGeometry' in the layer 'fields' information. If you are using a map service layer, features will not have geometry [url: ${url}]")))},_fixRendererFields:function(){var a=this.renderer;if(a&&0<this.fields.length){var b=[],c,e,a=h.filter([a,a.observationRenderer,a.latestObservationRenderer,a.trackRenderer],r.isDefined),g=[].concat(a);h.forEach(a,function(a){h.forEach(a.rendererInfos,function(a){a.renderer&&g.push(a.renderer)})});
h.forEach(g,function(a){if((e=a.attributeField)&&!q.isFunction(e))if(c=!this._getField(e)&&this._getField(e,!0))a.attributeField=c.name;if(e=a.attributeField2)if(c=!this._getField(e)&&this._getField(e,!0))a.attributeField2=c.name;if(e=a.attributeField3)if(c=!this._getField(e)&&this._getField(e,!0))a.attributeField3=c.name;q.isFunction(a.attributeField)||b.push(a.attributeField);b.push(a.attributeField2);b.push(a.attributeField3);if((e=a.rotationInfo&&a.rotationInfo.field)&&!q.isFunction(e)){if(c=
!this._getField(e)&&this._getField(e,!0))e=a.rotationInfo.field=c.name;b.push(e)}if(a.proportionalSymbolInfo){if((e=a.proportionalSymbolInfo.field)&&!q.isFunction(e)){if(c=!this._getField(e)&&this._getField(e,!0))e=a.proportionalSymbolInfo.field=c.name;b.push(e)}if((e=a.proportionalSymbolInfo.normalizationField)&&!q.isFunction(e)){if(c=!this._getField(e)&&this._getField(e,!0))e=a.proportionalSymbolInfo.normalizationField=c.name;b.push(e)}}},this);this._rendererFields=h.filter(b,r.isDefined)}},_getField:function(a,
b){var c=this.fields;if(!c||0===c.length)return null;var e;b&&(a=a.toLowerCase());h.some(c,function(c){var g=!1;(g=b?c&&c.name.toLowerCase()===a?!0:!1:c&&c.name===a?!0:!1)&&(e=c);return g});return e},_getDateOpts:function(){this._dtOpts||(this._dtOpts={properties:h.map(h.filter(this.fields,function(a){return!!(a&&"esriFieldTypeDate"===a.type)}),function(a){return a.name})});return this._dtOpts},_applyNormalized:function(a,b){a&&b&&h.forEach(a,function(a,c){a&&b[c]&&a.setGeometry(b[c])})},_editHandler:function(a,
b,c,e,g,d){g=a.addResults;var f=a.updateResults;a=a.deleteResults;var k,m,p,l,n=this.objectIdField,r=this._mode,q=this._isTable;k=this.editFieldsInfo;var s=this.getOutFields()||[],v=k&&k.creatorField,x=k&&k.creationDateField,w=k&&k.editorField,z=k&&k.editDateField;k=k&&k.realm;-1===h.indexOf(s,"*")&&(v&&-1===h.indexOf(s,v)&&(v=null),x&&-1===h.indexOf(s,x)&&(x=null),w&&-1===h.indexOf(s,w)&&(w=null),z&&-1===h.indexOf(s,z)&&(z=null));var s=x||z?(new Date).getTime():null,u=v||w?this.getUserId():void 0;
u&&k&&(u=u+"@"+k);if(g)for(k=0;k<g.length;k++)g[k]=new J(g[k]),q||(m=g[k],m.success&&(m=m.objectId,p=b[k],(l=p._graphicsLayer)&&l!==this&&l.remove(p),l=p.attributes||{},l[n]=m,v&&(l[v]=u),w&&(l[w]=u),x&&(l[x]=s),z&&(l[z]=s),p.setAttributes(l),r._init&&r.drawFeature(p)));if(f)for(k=0;k<f.length;k++)if(f[k]=new J(f[k]),!q&&(m=f[k],m.success)){m=m.objectId;p=c[m];if(b=r._getFeature(m))b.geometry!==p.geometry&&b.setGeometry(L.fromJson(p.geometry.toJson())),this._repaint(b,m);p=b||p;l=p.attributes||{};
w&&(l[w]=u);z&&(l[z]=s);p.setAttributes(l)}if(a){c=[];for(k=0;k<a.length;k++)if(a[k]=new J(a[k]),!q&&(m=a[k],m.success&&(m=m.objectId,p=r._getFeature(m))))this._unSelectFeatureIIf(m,r)&&c.push(p),p._count=0,r._removeFeatureIIf(m);if(0<c.length)this.onSelectionComplete(c,this.constructor.SELECTION_SUBTRACT)}this._resolve([g,f,a],"onEditsComplete",e,d)},_sendAttachment:function(b,c,e,g,d){var f=this;return a({url:this._url.path+"/"+c+"/"+("add"===b?"addAttachment":"updateAttachment"),form:e,content:q.mixin(this._url.query,
{f:"json",token:this._getToken()||void 0}),callbackParamName:"callback.html",handleAs:"json"}).addCallback(function(a){var e="add"===b?"onAddAttachmentComplete":"onUpdateAttachmentComplete";a=new J(a["add"===b?"addAttachmentResult":"updateAttachmentResult"]);a.attachmentId=a.objectId;a.objectId=c;f._resolve([a],e,g);return a}).addErrback(function(a){f._resolve([a],null,d,null,!0)})},_repaint:function(a,b,c){b=r.isDefined(b)?b:a.attributes[this.objectIdField];(!(b in this._selectedFeatures)||!this._selectionSymbol)&&
a.setSymbol(a.symbol,c)},_getKind:function(a){var b=this._trackManager;return b?b.isLatestObservation(a)?1:0:0}});q.mixin(l,{MODE_SNAPSHOT:0,MODE_ONDEMAND:1,MODE_SELECTION:2,SELECTION_NEW:3,SELECTION_ADD:4,SELECTION_SUBTRACT:5,POPUP_NONE:"esriServerHTMLPopupTypeNone",POPUP_HTML_TEXT:"esriServerHTMLPopupTypeAsHTMLText",POPUP_URL:"esriServerHTMLPopupTypeAsURL"});X._createWrappers(l);p("extend-esri")&&q.setObject("layers.FeatureLayer",l,b);return l})},"dojo/DeferredList":function(){define(["./_base/kernel",
"./_base/Deferred","./_base/array"],function(l,f,q){l.DeferredList=function(h,l,n,d,p){var c=[];f.call(this);var k=this;0===h.length&&!l&&this.resolve([0,[]]);var m=0;q.forEach(h,function(b,f){function a(a,b){c[f]=[a,b];m++;m===h.length&&k.resolve(c)}b.then(function(b){l?k.resolve([f,b]):a(!0,b)},function(b){n?k.reject(b):a(!1,b);if(d)return null;throw b;})})};l.DeferredList.prototype=new f;l.DeferredList.prototype.gatherResults=function(f){f=new l.DeferredList(f,!1,!0,!1);f.addCallback(function(f){var h=
[];q.forEach(f,function(d){h.push(d[1])});return h});return f};return l.DeferredList})},"esri/layers/KMLFolder":function(){define(["dojo/_base/declare","dojo/_base/lang","dojo/has","esri/kernel","esri/lang"],function(l,f,q,h,s){l=l(null,{declaredClass:"esri.layers.KMLFolder",constructor:function(h){f.mixin(this,h);s.isDefined(this.visibility)&&(this.visible=!!this.visibility)}});q("extend-esri")&&f.setObject("layers.KMLFolder",l,h);return l})},"esri/layers/TrackManager":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has esri/kernel esri/graphic esri/geometry/Polyline esri/layers/GraphicsLayer".split(" "),
function(l,f,q,h,s,n,d,p){l=l(null,{declaredClass:"esri.layers._TrackManager",constructor:function(c){this.layer=c;this.trackMap={}},initialize:function(c){this.map=c;var d=this.layer,f=d._getRenderer(),f=f&&f.trackRenderer;if("esriGeometryPoint"===d.geometryType){var b=this.container=new p._GraphicsLayer({id:d.id+"_tracks",_child:!0});b.loaded=!0;b.onLoad(b);b._setMap(c,d._div);b.setRenderer(f)}},addFeatures:function(c){var d,f=this.trackMap,b=this.layer,p=b._trackIdField,a,g;q.forEach(c,function(b){a=
b.attributes;d=a[p];g=f[d]=f[d]||[];g.push(b)});var e=b._startTimeField,h=b.objectIdField;c=function(a,b){var c=a.attributes[e],g=b.attributes[e];return c===g?a.attributes[h]<b.attributes[h]?-1:1:c<g?-1:1};for(d in f)f[d].sort(c)},drawTracks:function(){var c=this.container;if(c){var f=this.trackMap,m=this.map.spatialReference,b,p,a,g,e,h=this.layer._trackIdField;for(b in f){p=f[b];a=[];for(g=p.length-1;0<=g;g--)(e=p[g].geometry)&&a.push([e.x,e.y]);p={};p[h]=b;0<a.length&&c.add(new n(new d({paths:[a],
spatialReference:m}),null,p))}}},moveLatestToFront:function(){q.forEach(this.getLatestObservations(),function(c){var d=c._shape;d&&d._moveToFront();this._repaint(c,null,!0)},this.layer)},getLatestObservations:function(){var c=[],d=this.layer._getRenderer(),f=this.trackMap,b;if(!d.latestObservationRenderer)return c;for(b in f)d=f[b],c.push(d[d.length-1]);return c},clearTracks:function(){var c=this.getLatestObservations();this.trackMap={};var d=this.container;d&&d.clear();q.forEach(c,function(c){this._repaint(c,
null,!0)},this.layer)},isLatestObservation:function(c){var d=this.trackMap[c.attributes[this.layer._trackIdField]];return d?d[d.length-1]===c:!1},destroy:function(){var c=this.container;c&&(c.clear(),c._unsetMap(this.map,this.layer._div));this.map=this.layer=this.trackMap=this.container=null}});h("extend-esri")&&f.setObject("layers._TrackManager",l,s);return l})},"esri/layers/WMSLayer":function(){define("require dojo/_base/kernel dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has esri/kernel esri/request esri/urlUtils esri/SpatialReference esri/geometry/Extent esri/layers/DynamicMapServiceLayer esri/layers/WMSLayerInfo dojo/query".split(" "),
function(l,f,q,h,s,n,d,p,c,k,m,b,r){q=q([b],{declaredClass:"esri.layers.WMSLayer",_CRS_TO_EPSG:{84:4326,83:4269,27:4267},_REVERSED_LAT_LONG_RANGES:[[4001,4999],[2044,2045],[2081,2083],[2085,2086],[2093,2093],[2096,2098],[2105,2132],[2169,2170],[2176,2180],[2193,2193],[2200,2200],[2206,2212],[2319,2319],[2320,2462],[2523,2549],[2551,2735],[2738,2758],[2935,2941],[2953,2953],[3006,3030],[3034,3035],[3058,3059],[3068,3068],[3114,3118],[3126,3138],[3300,3301],[3328,3335],[3346,3346],[3350,3352],[3366,
3366],[3416,3416],[20004,20032],[20064,20092],[21413,21423],[21473,21483],[21896,21899],[22171,22177],[22181,22187],[22191,22197],[25884,25884],[27205,27232],[27391,27398],[27492,27492],[28402,28432],[28462,28492],[30161,30179],[30800,30800],[31251,31259],[31275,31279],[31281,31290],[31466,31700]],_WEB_MERCATOR:[102100,3857,102113,900913],_WORLD_MERCATOR:[3395,54004],allExtents:[],constructor:function(a,b){this.url=a=this._stripParameters(a,"version service request bbox format height width layers srs crs styles transparent bgcolor exceptions time elevation sld wfs".split(" "));
this._url=c.urlToObject(a);this._getCapabilitiesURL=a;this._initLayer=h.hitch(this,this._initLayer);this._parseCapabilities=h.hitch(this,this._parseCapabilities);this._getCapabilitiesError=h.hitch(this,this._getCapabilitiesError);b?(this.imageFormat=this._getImageFormat(b.format),this.imageTransparency=!1===b.transparent?!1:!0,this.visibleLayers=b.visibleLayers?b.visibleLayers:[],b.resourceInfo?this._readResourceInfo(b.resourceInfo):this._getCapabilities()):(this.imageFormat="image/png",this.imageTransparency=
!0,this.visibleLayers=[],this._getCapabilities());this._blankImageURL=l.toUrl("esri/layers")+"/../images/pixel.png"},setVisibleLayers:function(a){this.visibleLayers=(a=this._checkVisibleLayersList(a))?a:[];this.refresh(!0)},setImageFormat:function(a){this.imageFormat=this._getImageFormat(a);this.refresh(!0)},setImageTransparency:function(a){this.imageTransparency=a;this.refresh(!0)},getImageUrl:function(a,b,e,d){if(!this.visibleLayers||0===this.visibleLayers.length)d(this._blankImageURL);else{var f=
a.spatialReference.wkid;if(s.some(this._WEB_MERCATOR,function(a){return a==f})){var k=s.filter(this.spatialReferences,function(a){return s.some(this._WEB_MERCATOR,function(b){return b==a})},this);0==k.length&&(k=s.filter(this.spatialReferences,function(a){return s.some(this._WORLD_MERCATOR,function(b){return b==a})},this));f=0<k.length?k[0]:this._WEB_MERCATOR[0]}this.spatialReferences=s.filter(this.spatialReferences,function(a){return a!==f});this.spatialReferences.unshift(f);var k=a.xmin,p=a.xmax,
m=a.ymin,h=a.ymax;a={SERVICE:"WMS",REQUEST:"GetMap"};a.FORMAT=this.imageFormat;a.TRANSPARENT=this.imageTransparency?"TRUE":"FALSE";a.STYLES="";a.VERSION=this.version;a.LAYERS=this.visibleLayers?this.visibleLayers.toString():null;a.WIDTH=b;a.HEIGHT=e;this.maxWidth<b&&(a.WIDTH=this.maxWidth);this.maxHeight<e&&(a.HEIGHT=this.maxHeight);b=f?f:NaN;isNaN(b)||("1.3.0"==this.version?a.CRS="EPSG:"+b:a.SRS="EPSG:"+b);"1.3.0"==this.version&&this._useLatLong(b)?a.BBOX=m+","+k+","+h+","+p:a.BBOX=k+","+m+","+p+
","+h;b=this.getMapURL;var l;b+=-1==b.indexOf("?")?"?":"";for(l in a)b+="?"==b.substring(b.length-1,b.length)?"":"\x26",b+=l+"\x3d"+a[l];d(c.addProxy(b))}},_initLayer:function(a,b){this.spatialReference=new k(this.extent.spatialReference);this.initialExtent=new m(this.extent);this.fullExtent=new m(this.extent);this.visibleLayers=this._checkVisibleLayersList(this.visibleLayers);this.loaded=!0;this.onLoad(this);var c=this._loadCallback;c&&(delete this._loadCallback,c(this))},_readResourceInfo:function(a){a.extent?
a.layerInfos?(this.extent=a.extent,this.allExtents[0]=a.extent,this.layerInfos=a.layerInfos,this.description=a.description?a.description:"",this.copyright=a.copyright?a.copyright:"",this.title=a.title?a.title:"",this.getMapURL=a.getMapURL?a.getMapURL:this._getCapabilitiesURL,this.version=a.version?a.version:"1.3.0",this.maxWidth=a.maxWidth?a.maxWidth:5E3,this.maxHeight=a.maxHeight?a.maxHeight:5E3,this.spatialReferences=a.spatialReferences?a.spatialReferences:[],this.imageFormat=this._getImageFormat(a.format),
this.setScaleRange(a.minScale,a.maxScale),this._initLayer()):console.error("esri.layers.WMSLayer: unable to find the 'layerInfos' property in resourceInfo"):console.error("esri.layers.WMSLayer: unable to find the 'extent' property in resourceInfo")},_getCapabilities:function(){var a=this._url.query?this._url.query:{};a.SERVICE="WMS";a.REQUEST="GetCapabilities";var b=this._url.path+"?",c;for(c in a)b+="?"==b.substring(b.length-1,b.length)?"":"\x26",b+=c+"\x3d"+a[c];p({url:b,handleAs:"xml",headers:{"Content-Type":null},
load:this._parseCapabilities,error:this._getCapabilitiesError},{usePost:!1})},_parseCapabilities:function(a){if(a){this.version=this._getAttributeValue("WMS_Capabilities","version",a,null);this.version||(this.version=this._getAttributeValue("WMT_MS_Capabilities","version",a,"1.3.0"));var b=this._getTag("Service",a);this.title=this._getTagValue("Title",b,"");if(!this.title||0==this.title.length)this.title=this._getTagValue("Name",b,"");this.copyright=this._getTagValue("AccessConstraints",b,"");this.description=
this._getTagValue("Abstract",b,"");this.maxWidth=parseInt(this._getTagValue("MaxWidth",b,5E3),10);this.maxHeight=parseInt(this._getTagValue("MaxHeight",b,5E3),10);if(b=this._getTag("Layer",a)){var c=this._getLayerInfo(b),d=0,k=null,b=this._getTag("Capability",a);s.forEach(b.childNodes,function(a){"Layer"==a.nodeName&&(0===d?k=a:(1===d&&c.name&&(c.name="",c.subLayers=[],c.subLayers.push(this._getLayerInfo(k))),c.subLayers.push(this._getLayerInfo(a))),d++)},this);if(c){this.layerInfos=c.subLayers;if(!this.layerInfos||
0==this.layerInfos.length)this.layerInfos=[c];this.extent=c.extent;this.allExtents=c.allExtents;this.spatialReferences=c.spatialReferences;0==this.spatialReferences.length&&0<this.layerInfos.length&&(this.spatialReferences=this.layerInfos[0].spatialReferences)}this.getMapURL=this._getCapabilitiesURL;if((b=f.query("DCPType",this._getTag("GetMap",a)))&&0<b.length)if((b=f.query("HTTP",b[0]))&&0<b.length)if((b=f.query("Get",b[0]))&&0<b.length)if(b=this._getAttributeValue("OnlineResource","xlink:href",
b[0],null))b.indexOf("\x26")==b.length-1&&(b=b.substring(0,b.length-1)),this.getMapURL=b;this.getMapFormats=[];0==f.query("Operation",a).length?s.forEach(f.query("Format",this._getTag("GetMap",a)),function(a){this.getMapFormats.push(a.text?a.text:a.textContent)},this):s.forEach(f.query("Operation",a),function(a){"GetMap"==a.getAttribute("name")&&s.forEach(f.query("Format",a),function(a){this.getMapFormats.push(a.text?a.text:a.textContent)},this)},this);s.some(this.getMapFormats,function(a){return-1<
a.indexOf(this.imageFormat)},this)||(this.imageFormat=this.getMapFormats[0]);this._initLayer()}else this._getCapabilitiesError({error:{message:"Response does not contain any layers."}})}else this.onError("GetCapabilities request for "+this._getCapabilitiesURL+" failed. (Response is null.)")},_getCapabilitiesError:function(a,b){this.onError("GetCapabilities request for "+this._getCapabilitiesURL+" failed.",a)},_getLayerInfo:function(a){if(!a)return null;var b=new r;b.name="";b.title="";b.description=
"";b.allExtents=[];b.spatialReferences=[];b.subLayers=[];var c=this._getTag("LatLonBoundingBox",a);c&&(b.allExtents[0]=this._getExtent(c,4326));if(c=this._getTag("EX_GeographicBoundingBox",a)){var d=new m(0,0,0,0,new k({wkid:4326}));d.xmin=parseFloat(this._getTagValue("westBoundLongitude",c,0));d.ymin=parseFloat(this._getTagValue("southBoundLatitude",c,0));d.xmax=parseFloat(this._getTagValue("eastBoundLongitude",c,0));d.ymax=parseFloat(this._getTagValue("northBoundLatitude",c,0));b.allExtents[0]=
d}b.extent=b.allExtents[0];var f=-1<s.indexOf(["1.0.0","1.1.0","1.1.1"],this.version)?"SRS":"CRS";s.forEach(a.childNodes,function(a){if("Name"==a.nodeName)b.name=(a.text?a.text:a.textContent)||"";else if("Title"==a.nodeName)b.title=(a.text?a.text:a.textContent)||"";else if("Abstract"==a.nodeName)b.description=(a.text?a.text:a.textContent)||"";else if("BoundingBox"==a.nodeName){var c=a.getAttribute(f);c&&0===c.indexOf("EPSG:")?(c=parseInt(c.substring(5),10),0!==c&&!isNaN(c)&&(a="1.3.0"==this.version?
this._getExtent(a,c,this._useLatLong(c)):this._getExtent(a,c),b.allExtents[c]=a,b.extent||(b.extent=a))):c&&0===c.indexOf("CRS:")?(c=parseInt(c.substring(4),10),0!==c&&!isNaN(c)&&(this._CRS_TO_EPSG[c]&&(c=this._CRS_TO_EPSG[c]),b.allExtents[c]=this._getExtent(a,c))):(c=parseInt(c,10),0!==c&&!isNaN(c)&&(b.allExtents[c]=this._getExtent(a,c)))}else if(a.nodeName==f)a=(a.text?a.text:a.textContent).split(" "),s.forEach(a,function(a){a=-1<a.indexOf(":")?parseInt(a.split(":")[1],10):parseInt(a,10);0!==a&&
!isNaN(a)&&(this._CRS_TO_EPSG[a]&&(a=this._CRS_TO_EPSG[a]),-1==s.indexOf(b.spatialReferences,a)&&b.spatialReferences.push(a))},this);else if("Style"==a.nodeName){if(a=this._getTag("LegendURL",a))if(a=this._getTag("OnlineResource",a))b.legendURL=a.getAttribute("xlink:href")}else"Layer"===a.nodeName&&b.subLayers.push(this._getLayerInfo(a))},this);b.title=b.title||b.name;return b},_getImageFormat:function(a){switch(a?a.toLowerCase():""){case "jpg":return"image/jpeg";case "bmp":return"image/bmp";case "gif":return"image/gif";
case "svg":return"image/svg+xml";default:return"image/png"}},getImageFormat:function(){switch(this.imageFormat?this.imageFormat.toLowerCase():""){case "image/jpeg":return"jpg";case "image/bmp":return"bmp";case "image/gif":return"gif";case "image/svg+xml":return"svg";default:return"png"}},_getExtent:function(a,b,c){var d;if(a){d=new m;var f=parseFloat(a.getAttribute("minx")),p=parseFloat(a.getAttribute("miny")),h=parseFloat(a.getAttribute("maxx"));a=parseFloat(a.getAttribute("maxy"));c?(d.xmin=isNaN(p)?
-1*Number.MAX_VALUE:p,d.ymin=isNaN(f)?-1*Number.MAX_VALUE:f,d.xmax=isNaN(a)?Number.MAX_VALUE:a,d.ymax=isNaN(h)?Number.MAX_VALUE:h):(d.xmin=isNaN(f)?-1*Number.MAX_VALUE:f,d.ymin=isNaN(p)?-1*Number.MAX_VALUE:p,d.xmax=isNaN(h)?Number.MAX_VALUE:h,d.ymax=isNaN(a)?Number.MAX_VALUE:a);d.spatialReference=new k({wkid:b})}return d},_useLatLong:function(a){var b,c;for(c=0;c<this._REVERSED_LAT_LONG_RANGES.length;c++){var d=this._REVERSED_LAT_LONG_RANGES[c];if(a>=d[0]&&a<=d[1]){b=!0;break}}return b},_getTag:function(a,
b){var c=f.query(a,b);return c&&0<c.length?c[0]:null},_getTagValue:function(a,b,c){return(a=f.query(a,b))&&0<a.length?a[0].text?a[0].text:a[0].textContent:c},_getAttributeValue:function(a,b,c,d){return(a=f.query(a,c))&&0<a.length?a[0].getAttribute(b):d},_checkVisibleLayersList:function(a){if(a&&(0<a.length&&this.layerInfos&&0<this.layerInfos.length)&&"number"==typeof a[0]){var b=[];s.forEach(a,function(a){a<this.layerInfos.length&&b.push(this.layerInfos[a].name)},this);a=b}return a},_stripParameters:function(a,
b){var e=c.urlToObject(a),d,f=[];for(d in e.query)-1===s.indexOf(b,d.toLowerCase())&&f.push(d+"\x3d"+e.query[d]);return e.path+(f.length?"?"+f.join("\x26"):"")}});n("extend-esri")&&h.setObject("layers.WMSLayer",q,d);return q})},"esri/layers/SnapshotMode":function(){define("dojo/_base/declare dojo/_base/lang dojo/has esri/kernel esri/SpatialReference esri/tasks/query esri/layers/RenderMode".split(" "),function(l,f,q,h,s,n,d){l=l([d],{declaredClass:"esri.layers._SnapshotMode",constructor:function(d){this.featureLayer=
d;this._featureMap={};this._drawFeatures=f.hitch(this,this._drawFeatures);this._queryErrorHandler=f.hitch(this,this._queryErrorHandler)},startup:function(){this.featureLayer._collection?this._applyTimeFilter():this._fetchAll()},propertyChangeHandler:function(d){this._init&&(d?this.featureLayer._collection?console.log("FeatureLayer: layer created by value (from a feature collection) does not support definition expressions and time definitions. Layer id \x3d "+this.featureLayer.id):this._fetchAll():
this._applyTimeFilter())},drawFeature:function(d){var c=d.attributes[this.featureLayer.objectIdField];this._addFeatureIIf(c,d);this._incRefCount(c)},resume:function(){this.propertyChangeHandler(0)},refresh:function(){var d=this.featureLayer;d._collection?(d._fireUpdateStart(),d._refresh(!0),d._fireUpdateEnd()):this._fetchAll()},_getRequestId:function(d){return("_"+d.name+d.layerId+d._ulid).replace(/[^a-zA-Z0-9\_]+/g,"_")},_fetchAll:function(){var d=this.featureLayer;!d._collection&&!d.suspended&&
(d._fireUpdateStart(),this._clearIIf(),this._sendRequest())},_sendRequest:function(){var d=this.map,c=this.featureLayer,f=c.getDefinitionExpression(),m=new n;m.outFields=c.getOutFields();m.where=f||"1\x3d1";m.returnGeometry=!0;m.outSpatialReference=new s(d.spatialReference.toJson());m.timeExtent=c.getTimeDefinition();m.maxAllowableOffset=c._maxOffset;c._ts&&(m._ts=(new Date).getTime());m.orderByFields=c.supportsAdvancedQueries?c.orderByFields:null;var b;c._usePatch&&(b=this._getRequestId(c),this._cancelPendingRequest(null,
b));c._task.execute(m,this._drawFeatures,this._queryErrorHandler,b)},_drawFeatures:function(d){this._purgeRequests();var c=d.features,f=this.featureLayer,m=f.objectIdField,b,h=c.length,a,g;for(b=0;b<h;b++)a=c[b],g=a.attributes[m],this._addFeatureIIf(g,a),this._incRefCount(g);this._applyTimeFilter(!0);f._fireUpdateEnd(null,d.exceededTransferLimit?{queryLimitExceeded:!0}:null);if(d.exceededTransferLimit)f.onQueryLimitExceeded()},_queryErrorHandler:function(d){this._purgeRequests();var c=this.featureLayer;
c._errorHandler(d);c._fireUpdateEnd(d)}});q("extend-esri")&&f.setObject("layers._SnapshotMode",l,h);return l})},"esri/layers/SelectionMode":function(){define(["dojo/_base/declare","dojo/_base/lang","dojo/has","esri/kernel","esri/layers/RenderMode"],function(l,f,q,h,s){l=l([s],{declaredClass:"esri.layers._SelectionMode",constructor:function(f){this.featureLayer=f;this._featureMap={}},propertyChangeHandler:function(f){this._init&&0===f&&this._applyTimeFilter()},resume:function(){this.propertyChangeHandler(0)}});
q("extend-esri")&&f.setObject("layers._SelectionMode",l,h);return l})},"esri/layers/GridLayout":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has esri/kernel esri/SpatialReference esri/geometry/Extent esri/geometry/Polyline".split(" "),function(l,f,q,h,s,n,d,p){l=l(null,{declaredClass:"esri.layers._GridLayout",constructor:function(c,d,f,b){this.origin=c;this.cellWidth=d.width;this.cellHeight=d.height;this.mapWidth=f.width;this.mapHeight=f.height;this.srInfo=b},setResolution:function(c){this._resolution=
(c.xmax-c.xmin)/this.mapWidth;this.srInfo&&(c=Math.round(2*this.srInfo.valid[1]/this._resolution),c=Math.round(c/this.cellWidth),this._frameStats=[c,0,c-1])},getCellCoordinates:function(c){var d=this._resolution,f=this.origin;return{row:Math.floor((f.y-c.y)/(this.cellHeight*d)),col:Math.floor((c.x-f.x)/(this.cellWidth*d))}},normalize:function(c){var d=this._frameStats;if(d){var f=d[0],b=d[1],d=d[2];c<b?(c%=f,c=c<b?c+f:c):c>d&&(c%=f)}return c},intersects:function(c,d){var f=this.srInfo;return f?q.some(d._getParts(f),
function(b){return c.intersects(b.extent)}):c.intersects(d)},getCellExtent:function(c,f){var m=this._resolution,b=this.origin,p=this.cellWidth,a=this.cellHeight;return new d(f*p*m+b.x,b.y-(c+1)*a*m,(f+1)*p*m+b.x,b.y-c*a*m,new n(b.spatialReference.toJson()))},getLatticeID:function(c){var d=this.getCellCoordinates({x:c.xmin,y:c.ymax}),f=this.getCellCoordinates({x:c.xmax,y:c.ymin});c=d.row;var b=f.row,d=this.normalize(d.col),f=this.normalize(f.col);return c+"_"+b+"_"+d+"_"+f},sorter:function(c,d){return c<
d?-1:1},getCellsInExtent:function(c,d){var f=this.getCellCoordinates({x:c.xmin,y:c.ymax}),b=this.getCellCoordinates({x:c.xmax,y:c.ymin}),h=f.row,a=b.row,f=f.col,b=b.col,g=[],e,l,n,q=[],s=[],F,A,w,u=[];for(e=h;e<=a;e++)for(l=f;l<=b;l++)n=this.normalize(l),c=this.getCellExtent(e,n),g.push({row:e,col:n,extent:c,resolution:this._resolution}),d&&(q.push(c.xmin,c.xmax),s.push(c.ymin,c.ymax));f=this.normalize(f);b=this.normalize(b);q.sort(this.sorter);s.sort(this.sorter);l=q.length;for(e=l-1;0<=e;e--)e<
l-1&&q[e]===q[e+1]&&q.splice(e,1);l=s.length;for(e=l-1;0<=e;e--)e<l-1&&s[e]===s[e+1]&&s.splice(e,1);if(q.length&&s.length){n=q[0];F=q[q.length-1];A=s[0];w=s[s.length-1];l=q.length;for(e=0;e<l;e++)u.push([[q[e],w],[q[e],A]]);l=s.length;for(e=0;e<l;e++)u.push([[n,s[e]],[F,s[e]]]);e=new p({paths:u,spatialReference:this.origin.spatialReference.toJson()});g.push({latticeID:h+"_"+a+"_"+f+"_"+b,lattice:e,resolution:this._resolution})}return{minRow:h,maxRow:a,minCol:f,maxCol:b,cells:g}}});h("extend-esri")&&
f.setObject("layers._GridLayout",l,s);return l})},"dojox/data/CsvStore":function(){define("dojo/_base/lang dojo/_base/declare dojo/_base/xhr dojo/_base/kernel dojo/data/util/filter dojo/data/util/simpleFetch".split(" "),function(l,f,q,h,s,n){f=f("dojox.data.CsvStore",null,{constructor:function(d){this._attributes=[];this._attributeIndexes={};this._dataArray=[];this._arrayOfAllItems=[];this._loadFinished=!1;d.url&&(this.url=d.url);this._csvData=d.data;d.label?this.label=d.label:""===this.label&&(this.label=
void 0);this._storeProp="_csvStore";this._idProp="_csvId";this._features={"dojo.data.api.Read":!0,"dojo.data.api.Identity":!0};this._loadInProgress=!1;this._queuedFetches=[];this.identifier=d.identifier;""===this.identifier?delete this.identifier:this._idMap={};"separator"in d&&(this.separator=d.separator);"urlPreventCache"in d&&(this.urlPreventCache=d.urlPreventCache?!0:!1)},url:"",label:"",identifier:"",separator:",",urlPreventCache:!1,_assertIsItem:function(d){if(!this.isItem(d))throw Error(this.declaredClass+
": a function was passed an item argument that was not an item");},_getIndex:function(d){d=this.getIdentity(d);this.identifier&&(d=this._idMap[d]);return d},getValue:function(d,f,c){this._assertIsItem(d);var k=c;if("string"===typeof f)f=this._attributeIndexes[f],null!=f&&(k=this._dataArray[this._getIndex(d)][f]||c);else throw Error(this.declaredClass+": a function was passed an attribute argument that was not a string");return k},getValues:function(d,f){var c=this.getValue(d,f);return c?[c]:[]},getAttributes:function(d){this._assertIsItem(d);
var f=[];d=this._dataArray[this._getIndex(d)];for(var c=0;c<d.length;c++)""!==d[c]&&f.push(this._attributes[c]);return f},hasAttribute:function(d,f){this._assertIsItem(d);if("string"===typeof f){var c=this._attributeIndexes[f],k=this._dataArray[this._getIndex(d)];return"undefined"!==typeof c&&c<k.length&&""!==k[c]}throw Error(this.declaredClass+": a function was passed an attribute argument that was not a string");},containsValue:function(d,f,c){var k=void 0;"string"===typeof c&&(k=s.patternToRegExp(c,
!1));return this._containsValue(d,f,c,k)},_containsValue:function(d,f,c,k){d=this.getValues(d,f);for(f=0;f<d.length;++f){var m=d[f];if("string"===typeof m&&k)return null!==m.match(k);if(c===m)return!0}return!1},isItem:function(d){if(d&&d[this._storeProp]===this)if(d=d[this._idProp],this.identifier){if(this._dataArray[this._idMap[d]])return!0}else if(0<=d&&d<this._dataArray.length)return!0;return!1},isItemLoaded:function(d){return this.isItem(d)},loadItem:function(d){},getFeatures:function(){return this._features},
getLabel:function(d){if(this.label&&this.isItem(d))return this.getValue(d,this.label)},getLabelAttributes:function(d){return this.label?[this.label]:null},_fetchItems:function(d,f,c){var k=this,m=function(a,b){var c=null;if(a.query){var d,g,c=[],m=a.queryOptions?a.queryOptions.ignoreCase:!1,h={};for(d in a.query)g=a.query[d],"string"===typeof g&&(h[d]=s.patternToRegExp(g,m));for(m=0;m<b.length;++m){var l=!0,n=b[m];for(d in a.query)g=a.query[d],k._containsValue(n,d,g,h[d])||(l=!1);l&&c.push(n)}}else c=
b.slice(0,b.length);f(c,a)};if(this._loadFinished)m(d,this._arrayOfAllItems);else if(""!==this.url)if(this._loadInProgress)this._queuedFetches.push({args:d,filter:m});else{this._loadInProgress=!0;var b=q.get({url:k.url,handleAs:"text",preventCache:k.urlPreventCache});b.addCallback(function(a){try{k._processData(a),m(d,k._arrayOfAllItems),k._handleQueuedFetches()}catch(b){c(b,d)}});b.addErrback(function(a){k._loadInProgress=!1;if(c)c(a,d);else throw a;});var h=null;d.abort&&(h=d.abort);d.abort=function(){b&&
-1===b.fired&&b.cancel();h&&h.call(d)}}else if(this._csvData)try{this._processData(this._csvData),this._csvData=null,m(d,this._arrayOfAllItems)}catch(a){c(a,d)}else{var g=Error(this.declaredClass+": No CSV source data was provided as either URL or String data input.");if(c)c(g,d);else throw g;}},close:function(d){},_getArrayOfArraysFromCsvFileContents:function(d){if(l.isString(d)){var f=RegExp("^\\s+","g"),c=RegExp("\\s+$","g"),k=RegExp('""',"g"),m=[],b=this._splitLines(d);for(d=0;d<b.length;++d){var h=
b[d];if(0<h.length){for(var h=h.split(this.separator),a=0;a<h.length;){var g=h[a].replace(f,""),e=g.replace(c,""),n=e.charAt(0),q=e.charAt(e.length-1),s=e.charAt(e.length-2),z=e.charAt(e.length-3);if(2===e.length&&'""'==e)h[a]="";else if('"'==n&&('"'!=q||'"'==q&&'"'==s&&'"'!=z)){if(a+1===h.length)return;h[a]=g+this.separator+h[a+1];h.splice(a+1,1)}else'"'==n&&'"'==q&&(e=e.slice(1,e.length-1),e=e.replace(k,'"')),h[a]=e,a+=1}m.push(h)}}this._attributes=m.shift();for(d=0;d<this._attributes.length;d++)this._attributeIndexes[this._attributes[d]]=
d;this._dataArray=m}},_splitLines:function(d){var f=[],c,k="",h=!1;for(c=0;c<d.length;c++){var b=d.charAt(c);switch(b){case '"':h=!h;k+=b;break;case "\r":h?k+=b:(f.push(k),k="",c<d.length-1&&"\n"==d.charAt(c+1)&&c++);break;case "\n":h?k+=b:(f.push(k),k="");break;default:k+=b}}""!==k&&f.push(k);return f},_processData:function(d){this._getArrayOfArraysFromCsvFileContents(d);this._arrayOfAllItems=[];if(this.identifier&&void 0===this._attributeIndexes[this.identifier])throw Error(this.declaredClass+": Identity specified is not a column header in the data set.");
for(d=0;d<this._dataArray.length;d++){var f=d;this.identifier&&(f=this._dataArray[d][this._attributeIndexes[this.identifier]],this._idMap[f]=d);this._arrayOfAllItems.push(this._createItemFromIdentity(f))}this._loadFinished=!0;this._loadInProgress=!1},_createItemFromIdentity:function(d){var f={};f[this._storeProp]=this;f[this._idProp]=d;return f},getIdentity:function(d){return this.isItem(d)?d[this._idProp]:null},fetchItemByIdentity:function(d){var f,c=d.scope?d.scope:h.global;if(this._loadFinished)f=
this._createItemFromIdentity(d.identity),this.isItem(f)||(f=null),d.onItem&&d.onItem.call(c,f);else{var k=this;if(""!==this.url)this._loadInProgress?this._queuedFetches.push({args:d}):(this._loadInProgress=!0,f=q.get({url:k.url,handleAs:"text"}),f.addCallback(function(b){try{k._processData(b);var f=k._createItemFromIdentity(d.identity);k.isItem(f)||(f=null);d.onItem&&d.onItem.call(c,f);k._handleQueuedFetches()}catch(a){d.onError&&d.onError.call(c,a)}}),f.addErrback(function(b){this._loadInProgress=
!1;d.onError&&d.onError.call(c,b)}));else if(this._csvData)try{k._processData(k._csvData),k._csvData=null,f=k._createItemFromIdentity(d.identity),k.isItem(f)||(f=null),d.onItem&&d.onItem.call(c,f)}catch(m){d.onError&&d.onError.call(c,m)}}},getIdentityAttributes:function(d){return this.identifier?[this.identifier]:null},_handleQueuedFetches:function(){if(0<this._queuedFetches.length){for(var d=0;d<this._queuedFetches.length;d++){var f=this._queuedFetches[d],c=f.filter,k=f.args;c?c(k,this._arrayOfAllItems):
this.fetchItemByIdentity(f.args)}this._queuedFetches=[]}}});l.extend(f,n);return f})},"esri/arcgis/csv":function(){define("dojo/_base/lang dojo/_base/array dojo/_base/Deferred dojo/sniff dojo/number dojox/data/CsvStore esri/kernel esri/config esri/request esri/SpatialReference esri/geometry/Point esri/geometry/jsonUtils esri/geometry/webMercatorUtils".split(" "),function(l,f,q,h,s,n,d,p,c,k,m,b,r){function a(a){var b=0,c="";f.forEach([","," ",";","|","\t"],function(e){var d=a.split(e).length;d>b&&
(b=d,c=e)});return c}function g(a,b){if(!a||"[object Date]"!==Object.prototype.toString.call(a)||isNaN(a.getTime()))return!1;var c=!0;if(h("chrome")&&/\d+\W*$/.test(b)){var e=b.match(/[a-zA-Z]{2,}/);if(e){for(var c=!1,d=0,f=e.length,g=/^((jan(uary)?)|(feb(ruary)?)|(mar(ch)?)|(apr(il)?)|(may)|(jun(e)?)|(jul(y)?)|(aug(ust)?)|(sep(tember)?)|(oct(ober)?)|(nov(ember)?)|(dec(ember)?)|(am)|(pm)|(gmt)|(utc))$/i;!c&&d<=f&&!(c=!g.test(e[d]));)d++;c=!c}}return c}function e(b,c,e){var d=b.indexOf("\n"),d=l.trim(b.substr(0,
d)),p=c.columnDelimiter;p||(p=a(d));var q=new n({data:b,separator:p});b=9>h("ie")?750:1001;q.fetch({start:0,count:b,onComplete:function(a,b){var d=0,h={layerDefinition:c.layerDefinition,featureSet:{features:[],geometryType:"esriGeometryPoint"}},l=h.layerDefinition.objectIdField;!l&&!f.some(h.layerDefinition.fields,function(a){return"esriFieldTypeOID"==a.type?(l=a.name,!0):!1})&&(h.layerDefinition.fields.push({name:"__OBJECTID",alias:"__OBJECTID",type:"esriFieldTypeOID",editable:!1,domain:null}),l=
"__OBJECTID");var p,n,r=q._attributes,w=[],D=[];f.forEach(h.layerDefinition.fields,function(a,b){"esriFieldTypeDate"===a.type?w.push(a.name):("esriFieldTypeDouble"===a.type||"esriFieldTypeInteger"===a.type)&&D.push(a.name)});c.locationInfo&&"coordinates"===c.locationInfo.locationType?(p=c.locationInfo.latitudeFieldName,n=c.locationInfo.longitudeFieldName):f.forEach(r,function(a){var b;b=f.indexOf(z,a.toLowerCase());-1!==b&&(p=a);b=f.indexOf(F,a.toLowerCase());-1!==b&&(n=a)},this);if(!p||!n)setTimeout(function(){console.error("File does not seem to contain fields with point coordinates.")},
1);else{var r=0,v=a.length;for(r;r<v;r++){if(1E3<=h.featureSet.features.length){setTimeout(function(){console.error("1000 feature limit reached. Unable to load any more data.")},1);break}var x=a[r],E=q.getAttributes(x),y={};f.forEach(E,function(a,b){if(a){var c=a;0===a.length&&f.forEach(h.layerDefinition.fields,function(b,c){b.name==="attribute_"+(c-1)&&(a="attribute_"+(c-1))});if(f.some(w,function(b){return b===a})){var c=q.getValue(x,c),e=new Date(c);y[a]=g(e,c)?e.getTime():null}else if(f.some(D,
function(b){return b===a})){e=s.parse(q.getValue(x,c));if((a==p||a==n)&&(isNaN(e)||181<Math.abs(e)))e=parseFloat(q.getValue(x,c));isNaN(e)?y[a]=null:y[a]=e}else y[a]=q.getValue(x,c)}});y[l]=d;d++;var E=y[p],A=y[n];null==A||(null==E||isNaN(E)||isNaN(A))||(E={geometry:(new m(A,E,new k({wkid:4326}))).toJson(),attributes:y},h.featureSet.features.push(E))}h.layerDefinition.name="csv";e&&e(h)}},onError:function(a){console.error("Error fetching items from CSV store: ",a)}});return!0}function x(a,c,e,d,g,
k){0===a.length&&g(null);var h=b.getGeometryType(c),m=[];f.forEach(a,function(a){a=new h(a);a.spatialReference=e;m.push(a)},this);c=[102113,102100,3857];e.wkid&&4326===e.wkid&&d.wkid&&-1<f.indexOf(c,d.wkid)?(f.forEach(m,function(a){a.xmin?(a.xmin=Math.max(a.xmin,-180),a.xmax=Math.min(a.xmax,180),a.ymin=Math.max(a.ymin,-89.99),a.ymax=Math.min(a.ymax,89.99)):a.rings?f.forEach(a.rings,function(a){f.forEach(a,function(a){a[0]=Math.min(Math.max(a[0],-180),180);a[1]=Math.min(Math.max(a[1],-89.99),89.99)},
this)},this):a.paths?f.forEach(a.paths,function(a){f.forEach(a,function(a){a[0]=Math.min(Math.max(a[0],-180),180);a[1]=Math.min(Math.max(a[1],-89.99),89.99)},this)},this):a.x&&(a.x=Math.min(Math.max(a.x,-180),180),a.y=Math.min(Math.max(a.y,-89.99),89.99))},this),a=[],f.forEach(m,function(b){b=r.geographicToWebMercator(b);102100!==d.wkid&&(b.spatialReference=d);a.push(b.toJson())},this),g(a)):null!==e.wkid&&-1<f.indexOf(c,e.wkid)&&null!==d.wkid&&4326===d.wkid?(a=[],f.forEach(m,function(b){a.push(r.webMercatorToGeographic(b).toJson())},
this),g(a)):(c=function(b,c){b&&b.length===a.length?(a=[],f.forEach(b,function(b){b&&(b.rings&&0<b.rings.length&&0<b.rings[0].length&&0<b.rings[0][0].length&&!isNaN(b.rings[0][0][0])&&!isNaN(b.rings[0][0][1])||b.paths&&0<b.paths.length&&0<b.paths[0].length&&0<b.paths[0][0].length&&!isNaN(b.paths[0][0][0])&&!isNaN(b.paths[0][0][1])||b.xmin&&!isNaN(b.xmin)&&b.ymin&&!isNaN(b.ymin)||b.x&&!isNaN(b.x)&&b.y&&!isNaN(b.y))?a.push(b.toJson()):a.push(null)},this),g(a)):k(b,c)},p.defaults.geometryService?p.defaults.geometryService.project(m,
d,l.hitch(this,c),k):g(null))}function y(a,b){var c=[102113,102100,3857];return a&&b&&a.wkid===b.wkid&&a.wkt===b.wkt||a&&b&&a.wkid&&b.wkid&&-1<f.indexOf(c,a.wkid)&&-1<f.indexOf(c,b.wkid)?!0:!1}function v(a,b,c,e){if(a.featureSet&&0!==a.featureSet.length)if(y(c,b))e(a);else{var d=function(b){var c=[];f.forEach(a.featureSet.features,function(a,e){b[e]&&(a.geometry=b[e],c.push(a))},this);e(a)},g=function(b,c){console.error("error projecting featureSet ("+a.layerDefinition.name+"). Final try.");e(a)},
k=function(e,f){console.error("error projecting featureSet ("+a.layerDefinition.name+"). Try one more time.");x(h,a.featureSet.geometryType,b,c,l.hitch(this,d),l.hitch(this,g))};if(a.featureSet.features&&0<a.featureSet.features.length){var h=[];f.forEach(a.featureSet.features,function(a){h.push(a.geometry)});x(h,a.featureSet.geometryType,b,c,l.hitch(this,d),l.hitch(this,k))}else e(a)}}var z="lat latitude y ycenter latitude83 latdecdeg POINT-Y".split(" "),F="lon lng long longitude x xcenter longitude83 longdecdeg POINT-X".split(" "),
A={latFieldStrings:z,longFieldStrings:F,buildCSVFeatureCollection:function(a){var b=new q,d=function(a){b.callback(a)};c({url:a.url,handleAs:"text",load:function(b){e(b,a,l.hitch(this,d))},error:function(a){console.error("error: "+a)}},{usePost:!1});return b},projectFeatureCollection:function(a,b){var c=new q;v(a,new k({wkid:4326}),b,l.hitch(this,function(a){c.callback(a)}));return c},generateDefaultPopupInfo:function(a){var b={esriFieldTypeDouble:1,esriFieldTypeSingle:1},c={esriFieldTypeInteger:1,
esriFieldTypeSmallInteger:1},e={esriFieldTypeDate:1},d=null;a=f.map(a.layerDefinition.fields,l.hitch(this,function(a){"NAME"===a.name.toUpperCase()&&(d=a.name);var f="esriFieldTypeOID"!==a.type&&"esriFieldTypeGlobalID"!==a.type&&"esriFieldTypeGeometry"!==a.type,g=null;if(f){var k=a.name.toLowerCase();if(-1<",stretched value,fnode_,tnode_,lpoly_,rpoly_,poly_,subclass,subclass_,rings_ok,rings_nok,".indexOf(","+k+",")||-1<k.indexOf("area")||-1<k.indexOf("length")||-1<k.indexOf("shape")||-1<k.indexOf("perimeter")||
-1<k.indexOf("objectid")||k.indexOf("_")===k.length-1||k.indexOf("_i")===k.length-2&&1<k.length)f=!1;a.type in c?g={places:0,digitSeparator:!0}:a.type in b?g={places:2,digitSeparator:!0}:a.type in e&&(g={dateFormat:"shortDateShortTime"})}return l.mixin({},{fieldName:a.name,label:a.alias,isEditable:!0,tooltip:"",visible:f,format:g,stringFieldOption:"textbox"})}));return{title:d?"{"+d+"}":"",fieldInfos:a,description:null,showAttachments:!1,mediaInfos:[]}},_getSeparator:a,_isValidDate:g,_processCsvData:e,
_projectGeometries:x,_sameSpatialReference:y,_projectFeatureSet:v};h("extend-esri")&&l.setObject("arcgis.csv",A,d);return A})},"dojo/data/util/filter":function(){define(["../../_base/lang"],function(l){var f={};l.setObject("dojo.data.util.filter",f);f.patternToRegExp=function(f,h){for(var l="^",n=null,d=0;d<f.length;d++)switch(n=f.charAt(d),n){case "\\":l+=n;d++;l+=f.charAt(d);break;case "*":l+=".*";break;case "?":l+=".";break;case "$":case "^":case "/":case "+":case ".":case "|":case "(":case ")":case "{":case "}":case "[":case "]":l+=
"\\";default:l+=n}l+="$";return h?RegExp(l,"mi"):RegExp(l,"m")};return f})},"esri/layers/WMSLayerInfo":function(){define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/has","esri/kernel"],function(l,f,q,h,s){l=l(null,{declaredClass:"esri.layers.WMSLayerInfo",name:null,title:null,description:null,extent:null,legendURL:null,subLayers:[],allExtents:[],spatialReferences:[],constructor:function(f){f&&(this.name=f.name,this.title=f.title,this.description=f.description,this.extent=f.extent,
this.legendURL=f.legendURL,this.subLayers=f.subLayers?f.subLayers:[],this.allExtents=f.allExtents?f.allExtents:[],this.spatialReferences=f.spatialReferences?f.spatialReferences:[])},clone:function(){var f={name:this.name,title:this.title,description:this.description,legendURL:this.legendURL},d;this.extent&&(f.extent=this.extent.getExtent());f.subLayers=[];q.forEach(this.subLayers,function(d){f.subLayers.push(d.clone())});f.allExtents=[];for(d in this.allExtents)d=parseInt(d,10),isNaN(d)||(f.allExtents[d]=
this.allExtents[d].getExtent());f.spatialReferences=[];q.forEach(this.spatialReferences,function(d){f.spatialReferences.push(d)});return f}});h("extend-esri")&&f.setObject("layers.WMSLayerInfo",l,s);return l})},"esri/layers/FeatureType":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has esri/kernel esri/lang esri/symbols/jsonUtils esri/layers/RangeDomain esri/layers/CodedValueDomain esri/layers/InheritedDomain esri/layers/FeatureTemplate".split(" "),function(l,f,q,h,s,
n,d,p,c,k,m){l=l(null,{declaredClass:"esri.layers.FeatureType",constructor:function(b){if(b&&f.isObject(b)){this.id=b.id;this.name=b.name;var h=b.symbol;h&&(this.symbol=d.fromJson(h));var h=b.domains,a,g=this.domains={};for(a in h)if(h.hasOwnProperty(a)){var e=h[a];switch(e.type){case "range":g[a]=new p(e);break;case "codedValue":g[a]=new c(e);break;case "inherited":g[a]=new k(e)}}if(a=b.templates){h=this.templates=[];for(b=0;b<a.length;b++)h.push(new m(a[b]))}}},toJson:function(){var b={id:this.id,
name:this.name,symbol:this.symbol&&this.symbol.toJson()},c,a=this.domains,d=this.templates,e=n.fixJson;if(a){var f=b.domains={};for(c in a)a.hasOwnProperty(c)&&(f[c]=a[c]&&a[c].toJson());e(f)}d&&(b.templates=q.map(d,function(a){return a.toJson()}));return e(b)}});h("extend-esri")&&f.setObject("layers.FeatureType",l,s);return l})},"esri/layers/RenderMode":function(){define("dojo/_base/kernel dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has dojo/io/script esri/kernel".split(" "),function(l,
f,q,h,s,n,d){f=f(null,{declaredClass:"esri.layers._RenderMode",constructor:function(){this._prefix="jsonp_"+(l._scopeName||"dojo")+"IoScript"},initialize:function(d){this.map=d;this._init=!0},startup:function(){},propertyChangeHandler:function(d){},destroy:function(){this._init=!1},drawFeature:function(d){},suspend:function(){},resume:function(){},refresh:function(){},_incRefCount:function(d){(d=this._featureMap[d])&&d._count++},_decRefCount:function(d){(d=this._featureMap[d])&&d._count--},_getFeature:function(d){return this._featureMap[d]},
_addFeatureIIf:function(d,c){var f=this._featureMap,h=f[d],b=this.featureLayer;h||(f[d]=c,b._add(c),c._count=0);return h||c},_removeFeatureIIf:function(d){var c=this._featureMap[d],f=this.featureLayer;if(c){if(c._count)return;delete this._featureMap[d];f._remove(c)}return c},_clearIIf:function(){var d;d=this.featureLayer;var c=d.graphics,f=d._selectedFeatures,h=d.objectIdField;for(d=c.length-1;0<=d;d--){var b=c[d],l=b.attributes[h];l in f?b._count=1:(b._count=0,this._removeFeatureIIf(l))}},_isPending:function(d){return n[this._prefix+
d]?!0:!1},_cancelPendingRequest:function(d,c){if(d=d||n[this._prefix+c])try{d.cancel(),n._validCheck(d)}catch(f){}},_purgeRequests:function(){n._validCheck(null)},_toggleVisibility:function(d){var c=this.featureLayer,f=c.graphics,h=d?"show":"hide",b,l=f.length;d=d&&c._ager;for(b=0;b<l;b++){var a=f[b];a[h]();d&&c._repaint(a)}},_applyTimeFilter:function(d){var c=this.featureLayer;if(c.timeInfo&&!c.suspended){d||c._fireUpdateStart();var f=c._trackManager;f&&f.clearTracks();var l=c.getTimeDefinition(),
b=c._getOffsettedTE(c._mapTimeExtent);b?(b=c._getTimeOverlap(l,b))?(l=c._filterByTime(c.graphics,b.startTime,b.endTime),f&&f.addFeatures(l.match),h.forEach(l.match,function(b){var a=b._shape;b.visible||(b.show(),(a=b._shape)&&a._moveToFront());c._ager&&a&&c._repaint(b)}),h.forEach(l.noMatch,function(b){b.visible&&b.hide()})):this._toggleVisibility(!1):(f&&f.addFeatures(c.graphics),this._toggleVisibility(!0));f&&(f.moveLatestToFront(),f.drawTracks());d||c._fireUpdateEnd()}}});s("extend-esri")&&q.setObject("layers._RenderMode",
f,d);return f})},"esri/layers/GeoRSSLayer":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/json dojo/has esri/kernel esri/config esri/request esri/layers/ServiceGeneratedFeatureCollection".split(" "),function(l,f,q,h,s,n,d,p){l=l([p],{declaredClass:"esri.layers.GeoRSSLayer",serviceUrl:location.protocol+"//utility.arcgis.com/sharing/rss",constructor:function(c,d){n.defaults.geoRSSService&&(this.serviceUrl=n.defaults.geoRSSService);this._createLayer()},parse:function(){return this._io=
d({url:this.serviceUrl,content:{url:this.url,refresh:this.loaded?!0:void 0,outSR:this._outSR?q.toJson(this._outSR.toJson()):void 0},callbackParamName:"callback"})},_initLayer:function(c){this.inherited(arguments);this.loaded||(this.loaded=!0,this.onLoad(this))}});h("extend-esri")&&f.setObject("layers.GeoRSSLayer",l,s);return l})},"esri/layers/FeatureTemplate":function(){define("dojo/_base/declare dojo/_base/lang dojo/has esri/kernel esri/lang esri/graphic".split(" "),function(l,f,q,h,s,n){l=l(null,
{declaredClass:"esri.layers.FeatureTemplate",constructor:function(d){d&&f.isObject(d)&&(this.name=d.name,this.description=d.description,this.drawingTool=d.drawingTool,d=d.prototype,this.prototype=new n(d.geometry,null,d.attributes))},toJson:function(){return s.fixJson({name:this.name,description:this.description,drawingTool:this.drawingTool,prototype:this.prototype&&this.prototype.toJson()})}});f.mixin(l,{TOOL_AUTO_COMPLETE_POLYGON:"esriFeatureEditToolAutoCompletePolygon",TOOL_CIRCLE:"esriFeatureEditToolCircle",
TOOL_ELLIPSE:"esriFeatureEditToolEllipse",TOOL_FREEHAND:"esriFeatureEditToolFreehand",TOOL_LINE:"esriFeatureEditToolLine",TOOL_NONE:"esriFeatureEditToolNone",TOOL_POINT:"esriFeatureEditToolPoint",TOOL_POLYGON:"esriFeatureEditToolPolygon",TOOL_RECTANGLE:"esriFeatureEditToolRectangle",TOOL_ARROW:"esriFeatureEditToolArrow",TOOL_TRIANGLE:"esriFeatureEditToolTriangle",TOOL_LEFT_ARROW:"esriFeatureEditToolLeftArrow",TOOL_RIGHT_ARROW:"esriFeatureEditToolRightArrow",TOOL_UP_ARROW:"esriFeatureEditToolUpArrow",
TOOL_DOWN_ARROW:"esriFeatureEditToolDownArrow"});q("extend-esri")&&f.setObject("layers.FeatureTemplate",l,h);return l})},"*noref":1}});
define("esri/arcgis/utils","dojo/_base/lang dojo/_base/array dojo/_base/connect dojo/_base/Deferred dojo/_base/json dojo/_base/url dojo/has dojo/DeferredList dojo/dom-construct esri/kernel esri/config esri/lang esri/request esri/SpatialReference esri/map esri/urlUtils esri/geometry/ScreenPoint esri/geometry/Extent esri/geometry/webMercatorUtils esri/symbols/jsonUtils esri/renderers/jsonUtils esri/dijit/PopupTemplate esri/dijit/Popup esri/tasks/query esri/tasks/GeometryService esri/arcgis/csv esri/layers/ArcGISTiledMapServiceLayer esri/layers/ArcGISDynamicMapServiceLayer esri/layers/ArcGISImageServiceLayer esri/layers/OpenStreetMapLayer esri/layers/WebTiledLayer esri/layers/FeatureLayer esri/layers/WMSLayer esri/layers/KMLLayer esri/layers/GeoRSSLayer esri/virtualearth/VETiledLayer esri/layers/TileInfo esri/layers/DynamicLayerInfo esri/layers/LayerDrawingOptions esri/layers/ImageParameters esri/layers/ImageServiceParameters esri/layers/RasterFunction esri/layers/MosaicRule esri/layers/WMSLayerInfo dojo/i18n!esri/nls/jsapi".split(" "),function(l,
f,q,h,s,n,d,p,c,k,m,b,r,a,g,e,x,y,v,z,F,A,w,u,t,D,E,L,X,M,Y,G,Z,$,J,N,P,aa,ba,ca,Ba,Ca,Da,Ea,la){function O(a){return r({url:C.arcgisUrl+"/"+a.itemId+"/data",content:{f:"json"},callbackParamName:"callback"},{disableIdentityLookup:!0,_preLookup:!0})}function ma(a){var b={f:"json"};if(k.id){var c=k.id.findCredential(e.urlToObject(C.arcgisUrl).path);c&&(b.token=c.token)}return r({url:a,content:b,callbackParamName:"callback"},{disableIdentityLookup:!0})}function na(a){a.itemProperties.layerDefinition&&
(a.layerDefinition?(a.layerDefinition.drawingInfo||(a.layerDefinition.drawingInfo=a.itemProperties.layerDefinition.drawingInfo),b.isDefined(a.layerDefinition.definitionExpression)||(a.layerDefinition.definitionExpression=a.itemProperties.layerDefinition.definitionExpression),b.isDefined(a.layerDefinition.minScale)||(a.layerDefinition.minScale=a.itemProperties.layerDefinition.minScale),b.isDefined(a.layerDefinition.maxScale)||(a.layerDefinition.maxScale=a.itemProperties.layerDefinition.maxScale)):
a.layerDefinition=a.itemProperties.layerDefinition);a.itemProperties.popupInfo&&(!a.popupInfo&&!a.disablePopup)&&(a.popupInfo=a.itemProperties.popupInfo)}function Q(a,c){var e=new h,d=a.itemData,g=[],k=[];f.forEach(d.operationalLayers,function(a){if(a.itemId&&!a.type){var c=a.url.toLowerCase();-1<c.indexOf("/featureserver")?(k.push(a),g.push(O(a))):-1<c.indexOf("/mapserver")&&-1===c.indexOf("/mapserver/")&&(!a.layers||!b.isDefined(a.minScale)&&!b.isDefined(a.maxScale))?(k.push(a),g.push(O(a))):-1<
c.indexOf("/imageserver")&&(!b.isDefined(a.minScale)&&!b.isDefined(a.maxScale))&&(k.push(a),g.push(O(a)))}});d.baseMap&&d.baseMap.baseMapLayers&&f.forEach(d.baseMap.baseMapLayers,function(a){("BingMapsAerial"===a.type||"BingMapsRoad"===a.type||"BingMapsHybrid"===a.type)&&a.portalUrl?(k.push(a),g.push(ma(a.portalUrl))):a.itemId&&(k.push(a),g.push(O(a)))});0<g.length?(new p(g)).addCallback(function(d){f.forEach(k,function(a,e){if(("BingMapsAerial"===a.type||"BingMapsRoad"===a.type||"BingMapsHybrid"===
a.type)&&a.portalUrl)d[e][1].bingKey?c.bingMapsKey=d[e][1].bingKey:(a.errors=a.errors||[],a.errors.push({message:"The owner of the map has not provided a Bing Key for the Bing Map it includes. [type:"+a.type+"]"}));else{var g=d[e][1];if(g){var R=a.url.toLowerCase();-1<R.indexOf("/featureserver")&&g.layers?f.forEach(g.layers,function(b){R.endsWith("/featureserver/"+b.id)&&(a.itemProperties=b,na(a))}):-1<R.indexOf("/mapserver")?(g.layers&&!a.layers&&(a.layers=g.layers),b.isDefined(g.minScale)&&!b.isDefined(a.minScale)&&
(a.minScale=g.minScale),b.isDefined(g.maxScale)&&!b.isDefined(a.maxScale)&&(a.maxScale=g.maxScale),b.isDefined(g.refreshInterval)&&!b.isDefined(a.refreshInterval)&&(a.refreshInterval=g.refreshInterval)):-1<R.indexOf("/imageserver")&&(b.isDefined(g.minScale)&&!b.isDefined(a.minScale)&&(a.minScale=g.minScale),b.isDefined(g.maxScale)&&!b.isDefined(a.maxScale)&&(a.maxScale=g.maxScale),b.isDefined(g.refreshInterval)&&!b.isDefined(a.refreshInterval)&&(a.refreshInterval=g.refreshInterval),g.popupInfo&&(!a.popupInfo&&
!a.disablePopup)&&(a.popupInfo=g.popupInfo),g.renderingRule&&!a.renderingRule&&(a.renderingRule=g.renderingRule,g.renderingRule.functionName&&(a.renderingRule.rasterFunction=g.renderingRule.functionName)),g.bandIds&&!a.bandIds&&(a.bandIds=g.bandIds),g.mosaicRule&&!a.mosaicRule&&(a.mosaicRule=g.mosaicRule),g.format&&!a.format&&(a.format=g.format),b.isDefined(g.compressionQuality)&&!b.isDefined(a.compressionQuality)&&(a.compressionQuality=g.compressionQuality))}}});e.callback(a)}):e.callback(a);return e}
function da(a,b){var c=a.dynamicLayerInfos||a.layerInfos,e=b.layers;if(e&&c){var d=[],g=[],h=[],k=[],l=[],m=[];f.forEach(c,function(b){var c=b.id;if(!b.subLayerIds&&-1!==f.indexOf(a.visibleLayers,c))for(b=0;b<e.length;b++){var n=e[b];if(n.id===c){g.push(c);d.push(n.popupInfo);h.push(n.layerUrl||"");n.layerDefinition&&n.layerDefinition.definitionExpression?k.push(n.layerDefinition.definitionExpression):k.push("");l.push(esri.isDefined(n.minScale)?n.minScale:0);m.push(esri.isDefined(n.maxScale)?n.maxScale:
0);break}}});d.length&&(a.__popups=d,a.__popupIds=g,a.__popupUrls=h,a.__popupWhereClauses=k,a.__popupMinScales=l,a.__popupMaxScales=m,a.__resourceInfo=b.resourceInfo)}}function H(a){if(!a)return!1;var b=(new n(C.arcgisUrl)).authority;return-1!==a.indexOf(".arcgis.com/")||-1!==a.indexOf(b)}function oa(a){return!a?!1:-1!==a.indexOf("/services.arcgisonline.com/")||-1!==a.indexOf("/server.arcgisonline.com/")}function I(a){if("https:"===location.protocol&&(H(a)||oa(a)))a=a.replace("http:","https:");return a}
function B(a){var b=[];a.displayLevels||(b=f.map(a.resourceInfo.tileInfo.lods,function(a){return a.level}));b=new E(I(a.url),{resourceInfo:a.resourceInfo,opacity:a.opacity,visible:a.visibility,displayLevels:a.displayLevels||b,id:a.id,minScale:a.minScale,maxScale:a.maxScale,refreshInterval:a.refreshInterval});da(b,a);return b}function ea(a,b){if(!a||!b||0===b.length)return[];var c=","+b+",",e=[],d,f=",";for(d=0;d<a.length;d++)if(null!==a[d].subLayerIds){if(-1===c.indexOf(","+a[d].id+",")||-1<f.indexOf(","+
a[d].id+","))f+=a[d].subLayerIds.toString()+","}else-1<c.indexOf(","+a[d].id+",")&&-1===f.indexOf(","+a[d].id+",")&&e.push(a[d].id);return e}function pa(a){var b=new ca;b.format="png24";a.resourceInfo&&(a.resourceInfo.supportedImageFormatTypes&&-1<a.resourceInfo.supportedImageFormatTypes.indexOf("PNG32"))&&(b.format="png32");var b=new L(I(a.url),{resourceInfo:a.resourceInfo,opacity:a.opacity,visible:a.visibility,id:a.id,imageParameters:b,minScale:a.minScale,maxScale:a.maxScale,refreshInterval:a.refreshInterval}),
c=a.visibleLayers;if(!a.visibleLayers){var d="";f.forEach(b.layerInfos,function(a){a.defaultVisibility&&(d+=(0<d.length?",":"")+a.id)});c=d}if(a.layers&&0<a.layers.length){var e=[],g=[],h,k=[],m;f.forEach(a.layers,function(b){b.layerDefinition&&b.layerDefinition.definitionExpression&&(e[b.id]=b.layerDefinition.definitionExpression);if(b.layerDefinition&&b.layerDefinition.source){h=new aa(l.mixin(b,b.layerDefinition));delete h.layerDefinition;h.id=b.id;if(a.visibleLayers){var c="string"==typeof a.visibleLayers?
a.visibleLayers.split(","):a.visibleLayers;-1<f.indexOf(c,b.id)?h.defaultVisibility=!0:h.defaultVisibility=!1}g.push(h)}b.layerDefinition&&(b.layerDefinition.source&&b.layerDefinition.drawingInfo)&&(m=new ba(b.layerDefinition.drawingInfo),k[b.id]=m)},this);0<e.length&&b.setLayerDefinitions(e);0<g.length?(b.setDynamicLayerInfos(g,!0),0<k.length&&b.setLayerDrawingOptions(k,!0)):(c=ea(b.layerInfos,c),b.setVisibleLayers(c))}else c=ea(b.layerInfos,c),b.setVisibleLayers(c);da(b,a);return b}function Fa(a,
c){var d=new Ba;d.bandIds=a.bandIds;null!=a.format&&(d.format=a.format,null!=a.compressionQuality&&(d.compressionQuality=a.compressionQuality));if(a.renderingRule&&a.renderingRule.rasterFunction){var e=new Ca(a.renderingRule);d.renderingRule=e}a.mosaicRule&&(e=new Da(a.mosaicRule),d.mosaicRule=e);b.isDefined(a.noData)&&(d.noData=a.noData);b.isDefined(a.noDataInterpretation)&&(d.noDataInterpretation=a.noDataInterpretation);b.isDefined(a.interpolation)&&(d.interpolation=a.interpolation);d=new X(I(a.url),
{resourceInfo:a.resourceInfo,opacity:a.opacity,visible:a.visibility,id:a.id,imageServiceParameters:d,infoTemplate:a.popupInfo&&new c(a.popupInfo),minScale:a.minScale,maxScale:a.maxScale,refreshInterval:a.refreshInterval});a.layerDefinition&&a.layerDefinition.definitionExpression&&d.setDefinitionExpression(a.layerDefinition.definitionExpression,!0);return d}function fa(b,c,d){var e=[102113,102100,3857],g=d||new a(c[0].layerObject.fullExtent.spatialReference),h=new a(b.resourceInfo.fullExtent.spatialReference);
return g.wkt==h.wkt&&(g.wkid==h.wkid||esri.isDefined(g.latestWkid)&&g.latestWkid==h.wkid||esri.isDefined(h.latestWkid)&&g.wkid==h.latestWkid||esri.isDefined(g.latestWkid)&&g.latestWkid==h.latestWkid)||g.wkid&&h.wkid&&f.some(e,function(a){return a===h.wkid})&&f.some(e,function(a){return a===g.wkid})?!0:!1}function ga(a,b){if(!b[0].layerObject.tileInfo)return!1;var c=[];f.forEach(b,function(a){a.baseMapLayer&&a.layerObject.tileInfo&&(c=c.concat(f.map(a.layerObject.tileInfo.lods,function(a){return a.scale})))});
return f.some(a.resourceInfo.tileInfo.lods,function(a){return f.some(c,function(b){return b===a.scale})})}function ha(c,d,g,h,m){var n,p=g._clazz;if("OpenStreetMap"===c.type)n=new M({id:c.id,opacity:c.opacity,visible:null!==c.visibility&&void 0!==c.visibility?c.visibility:!0});else if("WMS"===c.type){var r=[],qa=[];f.forEach(c.layers,function(a){qa.push(new Ea({name:a.name,title:a.title,legendURL:a.legendURL}));r.push(a.name)},this);c.visibleLayers&&(r=c.visibleLayers);h={extent:new y(c.extent[0][0],
c.extent[0][1],c.extent[1][0],c.extent[1][1],new a({wkid:4326})),layerInfos:qa,version:c.version,maxWidth:c.maxWidth,maxHeight:c.maxHeight,getMapURL:c.mapUrl,spatialReferences:c.spatialReferences,title:c.title,copyright:c.copyright};n=new Z(c.url,{id:c.id,visibleLayers:r,format:"png",transparent:c.baseMapLayer?!1:!0,opacity:c.opacity,visible:null!==c.visibility?c.visibility:!0,resourceInfo:h,refreshInterval:c.refreshInterval});n.spatialReference.wkid=h.spatialReferences[0]}else if("KML"===c.type){g=
c.url;if(k.id&&(p=k.id.findCredential(e.urlToObject(C.arcgisUrl).path))){d=C.arcgisUrl.substring(C.arcgisUrl.indexOf("//")+2,C.arcgisUrl.indexOf("/",C.arcgisUrl.indexOf("//")+3));m=d.split(".");m=m[m.length-2]+"."+m[m.length-1];var ra=g.indexOf(m);-1<ra&&(g="https://"+d+g.substring(ra+m.length));g+="?token\x3d"+p.token}n=new $(g,{id:c.id,visible:null!==c.visibility?c.visibility:!0,outSR:h,refreshInterval:c.refreshInterval});q.connect(n,"onLoad",function(){var a=function(b){f.forEach(b,function(b){"esri.layers.FeatureLayer"===
b.declaredClass||"esri.layers.MapImageLayer"===b.declaredClass?b.setOpacity(c.opacity):"esri.layers.KMLLayer"===b.declaredClass&&(b.loaded?a(b.getLayers()):q.connect(b,"onLoad",l.hitch(this,function(b){a(b.getLayers())})))})};(c.opacity||0===c.opacity)&&a(n.getLayers());c.visibleFolders&&f.forEach(n.folders,function(a){-1<f.indexOf(c.visibleFolders,a.id)?n.setFolderVisibility(a,!0):n.setFolderVisibility(a,!1)},this)})}else"WebTiledLayer"===c.type?(n=new Y(c.templateUrl,{id:c.id,visible:null!==c.visibility?
c.visibility:!0,opacity:c.opacity,copyright:c.copyright,fullExtent:c.fullExtent&&new y(c.fullExtent),initialExtent:c.fullExtent&&new y(c.fullExtent),subDomains:c.subDomains,tileInfo:c.tileInfo?new P(c.tileInfo):null,refreshInterval:c.refreshInterval}),q.connect(n,"onLoad",function(){(b.isDefined(c.minScale)||b.isDefined(c.maxScale))&&n.setScaleRange(c.minScale,c.maxScale)})):"GeoRSS"===c.type?(n=new J(c.url,{id:c.id,opacity:c.opacity,outSpatialReference:h,refreshInterval:c.refreshInterval}),q.connect(n,
"onLoad",function(){!1===c.visibility&&n.hide();var a=n.getFeatureLayers();f.forEach(a,function(a){c.pointSymbol&&"esriGeometryPoint"===a.geometryType?a.renderer.symbol=z.fromJson(c.pointSymbol):c.lineSymbol&&"esriGeometryPolyline"===a.geometryType?a.renderer.symbol=z.fromJson(c.lineSymbol):c.polygonSymbol&&"esriGeometryPolygon"===a.geometryType&&(a.renderer.symbol=z.fromJson(c.polygonSymbol));(b.isDefined(c.minScale)||b.isDefined(c.maxScale))&&a.setScaleRange(c.minScale,c.maxScale)})})):"CSV"==c.type&&
c.url?n=new G(c.featureCollection,{infoTemplate:new A(c.popupInfo?c.popupInfo:D.generateDefaultPopupInfo(c.featureCollection)),id:c.id?c.id:null,outFields:["*"],visible:null!==c.visibility?c.visibility:!0,opacity:c.opacity,autoGeneralize:!0}):c.layerDefinition&&!c.url?(h=s.fromJson(s.toJson(c)),delete h.id,delete h.opacity,delete h.visibility,n=new G(h,{id:c.id,opacity:c.opacity,visible:c.visibility,outFields:["*"],infoTemplate:h.popupInfo&&new p(h.popupInfo),autoGeneralize:!0})):"BingMapsAerial"===
c.type||"BingMapsRoad"===c.type||"BingMapsHybrid"===c.type?g.bingMapsKey?(h=N.MAP_STYLE_AERIAL_WITH_LABELS,"BingMapsAerial"===c.type?h=N.MAP_STYLE_AERIAL:"BingMapsRoad"===c.type&&(h=N.MAP_STYLE_ROAD),n=new N({bingMapsKey:g.bingMapsKey,mapStyle:h,opacity:c.opacity,id:c.id})):(c.errors=c.errors||[],c.errors.push({message:"This application does not provide a Bing Key for the Bing layer that is included in this map. [type:"+c.type+"]"})):c.resourceInfo&&c.resourceInfo.mapName?n=!0===c.resourceInfo.singleFusedMapCache&&
(c.baseMapLayer||fa(c,d,h)&&ga(c,m))?B(c):pa(c):c.resourceInfo&&c.resourceInfo.pixelSizeX?n=!0===c.resourceInfo.singleFusedMapCache&&(c.baseMapLayer||fa(c,d,h)&&ga(c,m))?B(c):Fa(c,p):c.resourceInfo&&"Feature Layer"===c.resourceInfo.type&&(n=new G(I(c.url),{resourceInfo:c.resourceInfo,opacity:c.opacity,visible:c.visibility,id:c.id,mode:b.isDefined(c.mode)?c.mode:G.MODE_ONDEMAND,outFields:["*"],infoTemplate:c.popupInfo&&new p(c.popupInfo),autoGeneralize:!0,refreshInterval:c.refreshInterval}),c.layerDefinition&&
(c.layerDefinition.drawingInfo&&c.layerDefinition.drawingInfo.renderer&&(h=F.fromJson(c.layerDefinition.drawingInfo.renderer),h.isMaxInclusive=!0,n.setRenderer(h)),c.layerDefinition.definitionExpression&&n.setDefinitionExpression(c.layerDefinition.definitionExpression),b.isDefined(c.layerDefinition.minScale)&&n.setMinScale(c.layerDefinition.minScale),b.isDefined(c.layerDefinition.maxScale)&&n.setMaxScale(c.layerDefinition.maxScale)));n&&(n.arcgisProps={title:c.title},c.baseMapLayer&&(n._basemapGalleryLayerType=
c.isReference?"reference":"basemap"));return n}function S(a,b,c,d){f.forEach(a,function(e,f){if(e.url&&!e.type){if(0===f||a[0].layerObject)e.layerObject=ha(e,a,b,c,d)}else e.layerObject=ha(e,a,b,c,d)});var e=f.filter(a,function(a){return!a.isReference}),g=f.filter(a,function(a){return!!a.isReference});return a=e.concat(g)}function ja(b){var c=null;b=b[0];b.url&&!b.type?b.resourceInfo.spatialReference&&(c=new a,b.resourceInfo.spatialReference.wkid&&(c.wkid=b.resourceInfo.spatialReference.wkid),b.resourceInfo.spatialReference.wkt&&
(c.wkt=b.resourceInfo.spatialReference.wkt)):-1<b.type.indexOf("BingMaps")||"OpenStreetMap"==b.type?c=new a({wkid:102100}):"WMS"==b.type&&(c=new a({wkid:b.spatialReferences[0]}));return c}function sa(a,b,c,d,e,g,h){f.forEach(b,function(b,c){b.url&&!b.type?(b.resourceInfo=a[b.deferredsPos][1],delete b.deferredsPos):b.url&&"CSV"==b.type&&(b.featureCollection=d[b.deferredsPos].results[0],delete b.deferredsPos)});g=g||ja(b);var k=[];f.forEach(b,function(a){a.url&&"CSV"==a.type&&(a.deferredsPos=k.length,
k.push(D.projectFeatureCollection(a.featureCollection,g)))});0==k.length?(b=S(b,c,g,h),e.callback(b)):(new p(k)).addCallback(function(){f.forEach(b,function(a){a.url&&"CSV"==a.type&&(a.featureCollection=k[a.deferredsPos].results[0],delete a.deferredsPos)});b=S(b,c,g,h);e.callback(b)})}function ta(a,b){var c=I(a);return r({url:c,content:{f:"json"},callbackParamName:"callback",error:function(a,d){a.message=a.message?a.message+(" [url:"+c+"]"):"[url:"+c+"]";b.push(a);m.defaults.io.errorHandler(a,d)}})}
function T(a,b,c,d){var e=[],g=[],k=[],l=new h;f.forEach(a.operationalLayers,function(a,b){a.featureCollection?f.forEach(a.featureCollection.layers,function(c,d){var e=!0;a.visibleLayers&&-1==f.indexOf(a.visibleLayers,d)&&(e=!1);c.visibility=a.visibility&&e;c.opacity=a.opacity;c.id=(a.id||"operational"+b)+"_"+d;k.push(c)},this):k.push(a)});f.forEach(a.baseMap.baseMapLayers,function(a,b){a.baseMapLayer=!0;a.id=a.id||"base"+b;e.push(a)});f.forEach(k,function(a,b){a.id=a.id||"operational"+b;e.push(a)});
f.forEach(e,function(a){a.url&&!a.type?(a.deferredsPos=g.length,a.errors=[],g.push(ta(a.url,a.errors))):a.url&&"CSV"==a.type&&(a.deferredsPos=g.length,g.push(D.buildCSVFeatureCollection(a)))});0==g.length?(c=c||ja(e),e=S(e,b,c,d),l.callback(e)):(new p(g)).addCallback(function(a){sa(a,e,b,g,l,c,d)});return l}function ka(a,b){if(10.1>=b.version&&a){var c,d=parseInt(b.url.substring(b.url.lastIndexOf("/")+1,b.url.length));for(c=a.length-1;0<=c;c--)if(a[c].id==d)if(0==b.minScale&&0<a[c].minScale?b.minScale=
a[c].minScale:0<b.minScale&&0==a[c].minScale?b.minScale=b.minScale:0<b.minScale&&0<a[c].minScale&&(b.minScale=Math.min(b.minScale,a[c].minScale)),b.maxScale=Math.max(b.maxScale||0,a[c].maxScale||0),-1<a[c].parentLayerId)d=a[c].parentLayerId;else break}}function U(a,b,c,d){var e=a.url,g=a.__popupIds,h=a.__popupUrls,k=a.__popupWhereClauses,m=a.__popupMinScales,n=a.__popupMaxScales,p=a.__resourceInfo,s=[];f.forEach(a.__popups,function(d,l){if(d){var r,ia=[];f.forEach(d.fieldInfos,function(a){"shape"!==
a.fieldName.toLowerCase()&&ia.push(a.fieldName)});if(a.dynamicLayerInfos&&0<a.dynamicLayerInfos.length){var u=f.filter(a.dynamicLayerInfos,function(a){return g[l]==a.id})[0].source;r=new G(e+"/dynamicLayer",{id:a.id+"_"+g[l],source:u,outFields:ia,mode:G.MODE_SELECTION,infoTemplate:d&&new c(d),drawMode:!1,visible:a.visible,autoGeneralize:!0});r.loaded?(0<k[l].length&&r.setDefinitionExpression(k[l]),esri.isDefined(m[l])&&esri.isDefined(n[l])&&r.setScaleRange(m[l],n[l])):q.connect(r,"onLoad",function(a){0<
k[l].length&&r.setDefinitionExpression(k[l]);esri.isDefined(m[l])&&esri.isDefined(n[l])&&r.setScaleRange(m[l],n[l])})}else{var t,u=null;if(b)for(t=0;t<b.length;t++)if(b[t].id===g[l]){u=b[t];break}t=e+"/"+g[l];h[l].length&&(t=h[l]);r=new G(I(t),{id:a.id+"_"+g[l],outFields:ia,mode:G.MODE_SELECTION,infoTemplate:d&&new c(d),drawMode:!1,visible:a.visible,resourceInfo:u,autoGeneralize:!0});r.loaded?(r.setScaleRange(a.minScale,a.maxScale),0<k[l].length&&r.setDefinitionExpression(k[l])):q.connect(r,"onLoad",
function(b){b.setScaleRange(a.minScale,a.maxScale);0<k[l].length&&r.setDefinitionExpression(k[l])});r.loaded?ka(p.layers,r):q.connect(r,"onLoad",function(a){ka(p.layers,a)})}s.push(r)}});0<s.length&&(q.connect(a,"onVisibilityChange",l.hitch(this,function(a,b){f.forEach(a,function(a){b?a.show():a.hide()})},s)),q.connect(d,"onLayerRemove",l.hitch(this,function(a,b,c){a.id===c.id&&f.forEach(b,function(a){d.removeLayer(a)})},a,s)));delete a.__popups;delete a.__popupIds;delete a.__popupUrls;delete a.__popupWhereClauses;
delete a.__popupMinScales;delete a.__popupMaxScales;delete a.__resourceInfo;return s}function ua(a){return r({url:I(a.url+"/layers"),content:{f:"json"},callbackParamName:"callback",error:function(){}})}function va(a,b,c){var d=[];f.forEach(a,function(a){var b=a.__popups;b&&(1<b.length&&10<=a.version)&&(a.__deferredsPos=d.length,d.push(ua(a)))});var e=[];0<d.length?(new p(d)).addCallback(function(d){f.forEach(a,function(a){a.__popups&&0<a.__popups.length&&(a.__deferredsPos||0===a.__deferredsPos?(e=
e.concat(U(a,d[a.__deferredsPos][1].layers,c,b)),delete a.__deferredsPos):e=e.concat(U(a,null,c,b)))});b.addLayers(e)}):(f.forEach(a,function(a){a.__popups&&0<a.__popups.length&&(e=e.concat(U(a,null,c,b)))}),b.addLayers(e))}function wa(a){f.forEach(a,function(a){var b=a.layer;b.toJson&&(a=b.toJson(),a.featureSet&&-1<b.name.indexOf("Text")&&f.forEach(a.featureSet.features,function(a,c){if(a.attributes.TEXT){var d=b.graphics[c];d.symbol.setText(a.attributes.TEXT);a.symbol.horizontalAlignment&&(d.symbol.align=
a.symbol.horizontalAlignment);d.setSymbol(d.symbol);d.setAttributes(a.attributes)}},this))})}function xa(a){var b=6;f.forEach(a,function(a){if(a=a.renderer)"esri.renderer.SimpleRenderer"===a.declaredClass?((a=a.symbol)&&a.xoffset&&(b=Math.max(b,Math.abs(a.xoffset))),a&&a.yoffset&&(b=Math.max(b,Math.abs(a.yoffset)))):("esri.renderer.UniqueValueRenderer"===a.declaredClass||"esri.renderer.ClassBreaksRenderer"===a.declaredClass)&&f.forEach(a.infos,function(a){(a=a.symbol)&&a.xoffset&&(b=Math.max(b,Math.abs(a.xoffset)));
a&&a.yoffset&&(b=Math.max(b,Math.abs(a.yoffset)))})});return b}function V(a){var b=this,c=b.infoWindow,d=a.graphic;if(b.loaded){c.hide();c.clearFeatures();var e=[];f.forEach(b.graphicsLayerIds,function(a){if((a=b.getLayer(a))&&-1!==a.declaredClass.indexOf("FeatureLayer")&&a.loaded&&a.visible)a.clearSelection(),a.infoTemplate&&!a.suspended&&e.push(a)});f.forEach(b.layerIds,function(a){(a=b.getLayer(a))&&(-1!==a.declaredClass.indexOf("ArcGISImageServiceLayer")&&a.loaded&&a.visible&&a.infoTemplate)&&
e.push(a)});d=d&&d.getInfoTemplate()?d:null;if(e.length||d){var g=xa(e),k=a.screenPoint,l=b.toMap(new x(k.x-g,k.y+g)),g=b.toMap(new x(k.x+g,k.y-g)),l=new y(l.x,l.y,g.x,g.y,b.spatialReference),m=new u;m.geometry=l;m.timeExtent=b.timeExtent;var n=!0,l=f.map(e,function(a){var b;-1!==a.declaredClass.indexOf("ArcGISImageServiceLayer")?(n=!1,b=a.queryVisibleRasters(m,{rasterAttributeTableFieldPrefix:"Raster.",returnDomainValues:!0}),b.addCallback(function(){return a.getVisibleRasters()})):(b=a.selectFeatures(m),
b.addCallback(function(){return a.getSelectedFeatures()}));return b});d&&(g=new h,g.callback([d]),l.splice(0,0,g));if(!f.some(l,function(a){return-1===a.fired})){var p=d?1:0;f.forEach(e,function(a){p=-1!==a.declaredClass.indexOf("ArcGISImageServiceLayer")?p+a.getVisibleRasters().length:p+a.getSelectedFeatures().length});if(!p)return}c.setFeatures(l);c.show(a.mapPoint,{closestFirst:n})}}}function Ga(a,d){var e=d.mapOptions||{},f;e.infoWindow||(f=new w(null,c.create("div")),e.infoWindow=f);b.isDefined(e.showInfoWindowOnClick)||
(e.showInfoWindowOnClick=!1);e=new g(a,e);q.connect(e,"onLayersAddResult",wa);return e}function K(a,b,c,d,e,g){var h,k,l;d.map?(h=d.map,k=d.clickEventHandle,l=d.errors):(h=Ga(d,e),!e.ignorePopups&&!e.disableClickBehavior&&(k=q.connect(h,"onClick",V)));e.ignorePopups&&f.forEach(a,function(a){delete a.infoTemplate});h.addLayers(a);e.ignorePopups||va(a,h,e._clazz);var m=l||[];f.forEach(b,function(a){m=m.concat(a.errors)},this);h.loaded?g.callback({map:h,itemInfo:c,errors:m,clickEventHandle:k,clickEventListener:V}):
q.connect(h,"onLoad",function(){g.callback({map:h,itemInfo:c,errors:m,clickEventHandle:k,clickEventListener:V})})}function W(c,d,e,g,h){try{var k=e.mapOptions||{};e.mapOptions=k;var n=c.item,p=[];f.forEach(h,function(a){l.isArray(a.layerObject)?f.forEach(a.layerObject,function(a){p.push(a)}):p.push(a.layerObject)});if(p[0])if(p=f.filter(p,b.isDefined),n)if(n.extent&&n.extent.length)if(k.extent)K(p,h,c,d,e,g);else{var q=new y(n.extent[0][0],n.extent[0][1],n.extent[1][0],n.extent[1][1],new a({wkid:4326})),
r=p[0].spatialReference;4326===r.wkid?(k.extent=q,K(p,h,c,d,e,g)):102100===r.wkid||102113===r.wkid||3857===r.wkid?(q.xmin=Math.max(q.xmin,-180),q.xmax=Math.min(q.xmax,180),q.ymin=Math.max(q.ymin,-89.99),q.ymax=Math.min(q.ymax,89.99),k.extent=v.geographicToWebMercator(q),K(p,h,c,d,e,g)):e.geometryServiceURL||m.defaults.geometryService?(e.geometryServiceURL?new t(e.geometryServiceURL):m.defaults.geometryService).project([q],r,function(a){a=a[0];k.extent=k.extent||a;K(p,h,c,d,e,g)}):g.errback(Error(la.arcgis.utils.geometryServiceError))}else K(p,
h,c,d,e,g);else K(p,h,c,d,e,g);else n="",h[0].errors&&h[0].errors.length&&(n=" ("+h[0].errors[0].message+")"),g.errback(Error(la.arcgis.utils.baseLayerError+n))}catch(s){g.errback(s)}}function ya(a){var b=[];a=a.baseMap.baseMapLayers.concat(a.operationalLayers);f.forEach(a,function(a,c){var d={};if(a.featureCollection&&"CSV"!==a.type)!0===a.featureCollection.showLegend&&f.forEach(a.featureCollection.layers,function(c){!1!==c.showLegend&&(d={layer:c.layerObject,title:a.title,defaultSymbol:c.renderer&&
c.renderer.defaultSymbol&&c.renderer.defaultLabel?!0:!1},1<a.featureCollection.layers.length&&(d.title+=" - "+c.layerDefinition.name),b.push(d))});else if(a.baseMapLayer&&!0===a.showLegend&&a.layerObject||!a.baseMapLayer&&!1!==a.showLegend&&a.layerObject){var e=a.layerObject.renderer,e=!e||e&&e.defaultSymbol&&e.defaultLabel?!0:!1;if(10.1>a.layerObject.version&&(a.layerObject instanceof L||a.layerObject instanceof E)||a.layerObject instanceof esri.layers.ArcGISImageServiceLayer)e=!0;d={layer:a.layerObject,
title:a.title,defaultSymbol:e};a.layers&&(e=f.map(f.filter(a.layers,function(a){return!1===a.showLegend}),function(a){return a.id}),e.length&&(d.hideLayers=e));b.push(d)}});return b}function za(a,b,c,d){if(!d.itemData.operationalLayers||0===d.itemData.operationalLayers.length)Q(d,b).addCallback(function(d){T(d.itemData,b).addCallback(l.hitch(null,W,d,a,b,c))});else{var e=new h,g=d.itemData.baseMap.baseMapLayers.slice(0),k=f.filter(d.itemData.baseMap.baseMapLayers,function(a){return!a.isReference}),
m={item:d.item,itemData:{baseMap:{baseMapLayers:k}}};d.itemData.baseMap.baseMapLayers=f.filter(d.itemData.baseMap.baseMapLayers,function(a){return a.isReference});Q(m,b).addCallback(function(c){T(c.itemData,b).addCallback(l.hitch(null,W,c,a,b,e))});e.then(function(a){Q(d,b).addCallback(function(d){T(d.itemData,b,a.map.spatialReference,k).addCallback(function(e){d.itemData.baseMap.baseMapLayers=g;W(d,a,b,c,e)})})},l.hitch(c,c.errback))}}function Aa(a){C._arcgisUrl&&0<C._arcgisUrl.length&&(C.arcgisUrl=
C._arcgisUrl);var b=C.arcgisUrl+"/"+a,c={},d=new h;r({url:b,content:{f:"json"},callbackParamName:"callback",load:function(a){c.item=a;r({url:b+"/data",content:{f:"json"},callbackParamName:"callback",load:function(a){c.itemData=a;d.callback(c)},error:function(a){d.errback(a)}})},error:function(a){d.errback(a)}});return d}String.prototype.endsWith=function(a){return this.match(a+"$")==a};var C;C={arcgisUrl:location.protocol+"//www.arcgis.com/sharing/rest/content/items",getItem:Aa,createMap:function(a,
b,c){var d=new h;c=c||{};var e=c.infoTemplateClass;c._clazz=e&&(l.isObject(e)?e:l.getObject(e))||A;l.isString(a)?Aa(a).addCallback(l.hitch(null,za,b,c,d)).addErrback(l.hitch(d,d.errback)):za(b,c,d,a);return d},getLegendLayers:function(a){return a&&a.itemInfo&&a.itemInfo.itemData?ya(a.itemInfo.itemData):[]},_arcgisUrl:null,_getItemProps:Q,_getItemData:O,_getBingKey:ma,_processFSItemProperties:na,_getLayers:T,_preBuildLayerObjects:sa,_buildLayerObjects:S,_preCreateMap:W,_getMapSR:ja,_createMap:K,_addSelectionLayers:va,
_createSelectionFeatureLayers:U,_getServiceInfo:ta,_getLayersInfo:ua,_initLayer:ha,_loadAsCached:B,_loadAsDynamic:pa,_processPopups:da,_onLayersAddResult:wa,_sameSpatialReferenceAsBasemap:fa,_sameTilingSchemeAsBasemap:ga,_showPopup:V,_calculateClickTolerance:xa,_getVisibleFeatureLayers:ea,_updateLayerScaleInfo:ka,_checkUrl:I,_isHostedService:H,_isAgolService:oa,_getLegendLayers:ya};l.setObject("arcgis.utils",C,k);return C});